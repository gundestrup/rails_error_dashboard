<!DOCTYPE html>
<html>
  <head>
    <title>Error Dashboard - Audio Intelli API</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Apply theme immediately to prevent flash of wrong theme -->
    <script>
      // This runs BEFORE body renders to prevent flash
      (function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          // Add to html element so we can style body
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      })();
    </script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js with date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@5.0.1/dist/chartkick.min.js"></script>

    <!-- Turbo for real-time updates -->
    <script type="module">
      import * as Turbo from 'https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.12/+esm'
    </script>

    <style>
      :root {
        --primary-color: #8B5CF6;
        --success-color: #10B981;
        --danger-color: #EF4444;
        --warning-color: #F59E0B;
        --info-color: #3B82F6;
      }

      /* Light mode (default) */
      body {
        --bg-color: #F3F4F6;
        --text-color: #1F2937;
        --card-bg: #FFFFFF;
        --sidebar-bg: #FFFFFF;
        --sidebar-hover: #F9FAFB;
        --border-color: #E5E7EB;
        --table-hover: #F9FAFB;
        --nav-active-bg: #EDE9FE;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      /* Dark mode - support both class and data attribute for immediate loading */
      body.dark-mode,
      html[data-theme="dark"] body {
        --bg-color: #1A1B26;
        --text-color: #E4E5E9;
        --card-bg: #24283B;
        --sidebar-bg: #1F2130;
        --sidebar-hover: #2A2D3E;
        --border-color: #414868;
        --table-hover: #2A2D3E;
        --nav-active-bg: #2A2D3E;
      }

      .card {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .card-header {
        background-color: var(--card-bg) !important;
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .navbar {
        background: linear-gradient(135deg, var(--primary-color), #6D28D9);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .sidebar {
        background: var(--sidebar-bg);
        min-height: calc(100vh - 56px);
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
      }

      .sidebar .nav-link {
        color: var(--text-color);
        padding: 0.75rem 1.5rem;
        border-left: 3px solid transparent;
        transition: all 0.2s;
      }

      .sidebar .nav-link:hover {
        background-color: var(--sidebar-hover);
        color: var(--primary-color);
        border-left-color: var(--primary-color);
      }

      .sidebar .nav-link.active {
        background-color: var(--nav-active-bg);
        color: var(--primary-color);
        border-left-color: var(--primary-color);
        font-weight: 600;
      }

      .stat-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
      }

      .stat-label {
        color: #6B7280; /* Medium gray for light mode */
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Brighter stat labels in dark mode */
      body.dark-mode .stat-label,
      html[data-theme="dark"] body .stat-label {
        color: #9CA3AF; /* Lighter gray for better visibility in dark mode */
      }

      .badge-ios {
        background-color: #000000;
      }

      .badge-android {
        background-color: #3DDC84;
        color: #000;
      }

      .badge-api {
        background-color: var(--info-color);
      }

      .table {
        color: var(--text-color);
        background-color: var(--card-bg);
      }

      .table thead {
        background-color: var(--sidebar-hover);
        color: var(--text-color);
      }

      .table tbody {
        background-color: var(--card-bg);
      }

      .table-hover tbody tr {
        background-color: var(--card-bg);
      }

      .table-hover tbody tr:hover {
        background-color: var(--table-hover) !important;
        cursor: pointer;
      }

      .table-light {
        background-color: var(--sidebar-hover) !important;
        color: var(--text-color) !important;
      }

      /* Fix table cells in dark mode */
      .table td, .table th {
        background-color: var(--card-bg) !important;
        color: var(--text-color) !important;
        border-color: var(--border-color) !important;
      }

      .table thead th {
        background-color: var(--sidebar-hover) !important;
      }

      /* List group items (used in platform comparison and correlation pages) */
      .list-group-item {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .list-group-item-action {
        color: var(--text-color);
      }

      .list-group-item-action:hover,
      .list-group-item-action:focus {
        background-color: var(--table-hover);
        color: var(--text-color);
      }

      /* Override Bootstrap's default white backgrounds in dark mode */
      body.dark-mode .list-group-item,
      html[data-theme="dark"] body .list-group-item {
        background-color: var(--card-bg) !important;
        color: var(--text-color) !important;
        border-color: var(--border-color) !important;
      }

      body.dark-mode .list-group-item-action:hover,
      html[data-theme="dark"] body .list-group-item-action:hover {
        background-color: var(--table-hover) !important;
      }

      .form-control, .form-select {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus, .form-select:focus {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--primary-color);
      }

      .modal-content {
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      .modal-header, .modal-footer {
        border-color: var(--border-color);
      }

      .btn-close {
        filter: brightness(0) invert(1);
      }

      body.dark-mode .btn-close,
      html[data-theme="dark"] body .btn-close {
        filter: brightness(0) invert(1);
      }

      /* Light mode text-muted */
      .text-muted {
        color: #6B7280 !important; /* Medium gray for light mode */
      }

      /* Dark mode text-muted */
      body.dark-mode .text-muted,
      html[data-theme="dark"] body .text-muted {
        color: #D1D5DB !important; /* Lighter gray for dark mode */
      }

      .theme-toggle {
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        transition: background-color 0.2s;
      }

      .theme-toggle:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .error-status-resolved {
        color: var(--success-color);
      }

      .error-status-unresolved {
        color: var(--danger-color);
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
      }

      /* Real-time updates - new error animation */
      @keyframes slideInFade {
        0% {
          transform: translateY(-20px);
          opacity: 0;
          background-color: #FEF3C7;
        }
        10% {
          transform: translateY(0);
          opacity: 1;
          background-color: #FEF3C7;
        }
        100% {
          background-color: transparent;
        }
      }

      /* Highlight new errors */
      #error_list tr:first-child.new-error {
        animation: slideInFade 3s ease-out;
      }

      /* Live indicator pulse */
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      #live-indicator {
        animation: pulse 2s ease-in-out infinite;
      }

      /* Updated stat card pulse */
      @keyframes statPulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .stat-card.updated {
        animation: statPulse 0.5s ease-out;
      }

      /* Loading indicator */
      #loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #8B5CF6 0%, #6D28D9 100%);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
        z-index: 9999;
        display: none;
      }

      #loading-indicator.active {
        display: block;
        animation: loadingProgress 2s ease-in-out forwards;
      }

      @keyframes loadingProgress {
        0% { transform: scaleX(0); }
        50% { transform: scaleX(0.7); }
        100% { transform: scaleX(1); opacity: 0; }
      }
    </style>
  </head>

  <body>
    <!-- Loading Indicator -->
    <div id="loading-indicator"></div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="<%= root_path %>">
          <i class="bi bi-bug-fill"></i>
          Error Dashboard
        </a>
        <div class="d-flex align-items-center gap-3">
          <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
          </button>
          <div class="text-white">
            <small><%= Rails.env.titleize %> Environment</small>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-md-block sidebar">
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <%= link_to root_path, class: "nav-link #{request.path == root_path ? 'active' : ''}" do %>
                  <i class="bi bi-speedometer2"></i> Overview
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to errors_path, class: "nav-link #{request.path == errors_path ? 'active' : ''}" do %>
                  <i class="bi bi-list-ul"></i> All Errors
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to analytics_errors_path, class: "nav-link #{request.path == analytics_errors_path ? 'active' : ''}" do %>
                  <i class="bi bi-graph-up"></i> Analytics
                <% end %>
              </li>
              <% if RailsErrorDashboard.configuration.enable_platform_comparison %>
                <li class="nav-item">
                  <%= link_to platform_comparison_errors_path, class: "nav-link #{request.path == platform_comparison_errors_path ? 'active' : ''}" do %>
                    <i class="bi bi-phone"></i> Platform Health
                  <% end %>
                </li>
              <% end %>
              <% if RailsErrorDashboard.configuration.enable_error_correlation %>
                <li class="nav-item">
                  <%= link_to correlation_errors_path, class: "nav-link #{request.path == correlation_errors_path ? 'active' : ''}" do %>
                    <i class="bi bi-diagram-3"></i> Correlation
                  <% end %>
                </li>
              <% end %>
            </ul>

            <hr class="my-3">

            <h6 class="sidebar-heading px-3 mt-4 mb-2 text-muted text-uppercase">
              <small>Quick Filters</small>
            </h6>
            <ul class="nav flex-column">
              <li class="nav-item">
                <%= link_to errors_path(unresolved: true), class: "nav-link" do %>
                  <i class="bi bi-exclamation-circle text-danger"></i> Unresolved
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to errors_path(platform: 'iOS'), class: "nav-link" do %>
                  <i class="bi bi-phone"></i> iOS Errors
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to errors_path(platform: 'Android'), class: "nav-link" do %>
                  <i class="bi bi-phone"></i> Android Errors
                <% end %>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-10 ms-sm-auto px-md-4">
          <%= yield %>
        </main>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme Toggle Script -->
    <script>
      // Update Chart.js defaults for dark/light theme
      function updateChartTheme(isDark) {
        if (typeof Chart !== 'undefined') {
          const textColor = isDark ? '#E4E5E9' : '#1F2937';
          const gridColor = isDark ? 'rgba(65, 72, 104, 0.3)' : 'rgba(0, 0, 0, 0.1)';

          Chart.defaults.color = textColor;
          Chart.defaults.borderColor = gridColor;
          Chart.defaults.scale.grid.color = gridColor;
          Chart.defaults.scale.ticks.color = textColor;
          Chart.defaults.plugins.legend.labels.color = textColor;
          Chart.defaults.plugins.tooltip.backgroundColor = isDark ? '#24283B' : 'rgba(0, 0, 0, 0.8)';
          Chart.defaults.plugins.tooltip.titleColor = textColor;
          Chart.defaults.plugins.tooltip.bodyColor = textColor;
        }
      }

      // Load theme from localStorage on page load
      document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const isDark = savedTheme === 'dark';

        if (isDark) {
          document.body.classList.add('dark-mode');
          document.documentElement.setAttribute('data-theme', 'dark');
          updateThemeIcon(true);
        } else {
          // Ensure light mode is clean
          document.body.classList.remove('dark-mode');
          document.documentElement.removeAttribute('data-theme');
          updateThemeIcon(false);
        }

        // Update Chart.js theme
        updateChartTheme(isDark);
      });

      function toggleTheme() {
        const body = document.body;
        const isDark = body.classList.toggle('dark-mode');

        // Sync with html data attribute
        if (isDark) {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }

        // Save preference
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        // Update icon
        updateThemeIcon(isDark);

        // Update Chart.js theme
        updateChartTheme(isDark);

        // Reload page to apply chart theme (Chart.js requires re-render)
        setTimeout(() => location.reload(), 100);
      }

      function updateThemeIcon(isDark) {
        const icon = document.getElementById('themeIcon');
        if (isDark) {
          icon.className = 'bi bi-sun-fill';
        } else {
          icon.className = 'bi bi-moon-fill';
        }
      }

      // Loading indicator for form submissions and link clicks
      const loadingIndicator = document.getElementById('loading-indicator');

      // Show loading on form submit
      document.addEventListener('submit', function() {
        loadingIndicator.classList.add('active');
      });

      // Show loading on link clicks (except anchors)
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href && !link.href.startsWith('#') && !link.target) {
          loadingIndicator.classList.add('active');
        }
      });

      // Hide loading when page loads
      window.addEventListener('load', function() {
        loadingIndicator.classList.remove('active');
      });
    </script>
  </body>
</html>
