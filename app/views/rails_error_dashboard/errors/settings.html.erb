<% content_for :page_title, "Settings" %>

<%
  # Define setting groups with metadata
  setting_groups = {
    "Core Features" => {
      icon: "bi-shield-check",
      color: "primary",
      settings: {
        enable_middleware: { label: "Error Middleware", description: "Catches unhandled exceptions", type: :boolean },
        enable_error_subscriber: { label: "Rails.error Subscriber", description: "Subscribes to Rails error events", type: :boolean },
        retention_days: { label: "Data Retention", description: "Manual cleanup only (run: rails error_dashboard:cleanup_resolved DAYS=90)", type: :retention_days },
        max_backtrace_lines: { label: "Max Backtrace Lines", description: "Stack trace depth limit", type: :integer, unit: "lines" },
        sampling_rate: { label: "Sampling Rate", description: "Percentage of errors captured", type: :percentage }
      }
    },
    "Multi-App Support" => {
      icon: "bi-collection",
      color: "info",
      settings: {
        application_name: { label: "Application Name", description: "Name of this application (auto-detected if not set)", type: :application_name },
        database: { label: "Database Connection", description: "Active database for error logs", type: :database_name },
        use_separate_database: { label: "Separate Database", description: "Use dedicated DB for error logs", type: :boolean }
      }
    },
    "User Integration" => {
      icon: "bi-people",
      color: "secondary",
      settings: {
        user_model: { label: "User Model", description: "Model name for user associations (auto-detected if not set)", type: :user_model },
        total_users_for_impact: { label: "Total Users", description: "For impact % calculation (auto-detected if not set)", type: :total_users }
      }
    },
    "Performance Settings" => {
      icon: "bi-lightning-charge",
      color: "warning",
      settings: {
        async_logging: { label: "Async Logging", description: "Background job processing", type: :boolean, extra: :async_adapter },
        async_adapter: { label: "Async Adapter", description: "Job queue adapter", type: :symbol, show_if: :async_logging },
        enable_rate_limiting: { label: "Rate Limiting", description: "Throttle API requests", type: :boolean },
        rate_limit_per_minute: { label: "Rate Limit Threshold", description: "Requests per minute per IP", type: :integer, show_if: :enable_rate_limiting }
      }
    },
    "Notification Channels" => {
      icon: "bi-bell",
      color: "info",
      settings: {
        enable_slack_notifications: { label: "Slack", description: "Real-time notifications", type: :boolean },
        slack_webhook_url: { label: "Slack Webhook URL", description: "Slack webhook endpoint", type: :url, show_if: :enable_slack_notifications },
        enable_email_notifications: { label: "Email", description: "Email alerts", type: :boolean },
        notification_email_recipients: { label: "Email Recipients", description: "Recipient addresses", type: :array, show_if: :enable_email_notifications },
        notification_email_from: { label: "Email From", description: "Sender address", type: :string, show_if: :enable_email_notifications },
        enable_discord_notifications: { label: "Discord", description: "Discord webhook notifications", type: :boolean },
        discord_webhook_url: { label: "Discord Webhook URL", description: "Discord webhook endpoint", type: :url, show_if: :enable_discord_notifications },
        enable_pagerduty_notifications: { label: "PagerDuty", description: "Critical error escalation", type: :boolean },
        pagerduty_integration_key: { label: "PagerDuty Integration Key", description: "PagerDuty API key", type: :string, show_if: :enable_pagerduty_notifications },
        enable_webhook_notifications: { label: "Custom Webhooks", description: "Generic webhook endpoints", type: :boolean },
        webhook_urls: { label: "Webhook URLs", description: "Custom webhook endpoints", type: :array, show_if: :enable_webhook_notifications }
      }
    },
    "Advanced Analytics Features" => {
      icon: "bi-graph-up",
      color: "success",
      settings: {
        enable_similar_errors: { label: "Similar Errors (Fuzzy Matching)", description: "Find related errors by similarity", type: :boolean },
        enable_co_occurring_errors: { label: "Co-occurring Errors", description: "Errors happening together", type: :boolean },
        enable_error_cascades: { label: "Error Cascades", description: "Parent→child error chains", type: :boolean },
        enable_error_correlation: { label: "Error Correlation", description: "Version/user/time analysis", type: :boolean },
        enable_platform_comparison: { label: "Platform Comparison", description: "iOS vs Android analytics", type: :boolean },
        enable_occurrence_patterns: { label: "Occurrence Patterns", description: "Cyclical/burst detection", type: :boolean },
        enable_baseline_alerts: { label: "Baseline Alerts", description: "Anomaly detection", type: :boolean },
        baseline_alert_threshold_std_devs: { label: "Alert Threshold", description: "Standard deviations to trigger alert", type: :float, show_if: :enable_baseline_alerts, unit: "σ" },
        baseline_alert_severities: { label: "Alert Severities", description: "Severities to alert on", type: :array, show_if: :enable_baseline_alerts },
        baseline_alert_cooldown_minutes: { label: "Alert Cooldown", description: "Minutes between alerts for same error type", type: :integer, show_if: :enable_baseline_alerts, unit: "minutes" }
      }
    },
    "Source Code Integration" => {
      icon: "bi-code-square",
      color: "dark",
      settings: {
        enable_source_code_integration: { label: "Source Code Integration", description: "Show code in backtrace", type: :boolean },
        source_code_context_lines: { label: "Context Lines", description: "Lines before/after target line", type: :integer, show_if: :enable_source_code_integration },
        enable_git_blame: { label: "Git Blame", description: "Show git blame info", type: :boolean, show_if: :enable_source_code_integration },
        source_code_cache_ttl: { label: "Cache TTL", description: "Source code cache duration", type: :integer, show_if: :enable_source_code_integration, unit: "seconds" },
        only_show_app_code_source: { label: "Only App Code", description: "Hide gems/stdlib for security", type: :boolean, show_if: :enable_source_code_integration },
        git_branch_strategy: { label: "Git Branch Strategy", description: "Branch resolution strategy", type: :symbol, show_if: :enable_source_code_integration }
      }
    },
    "Enhanced Metrics" => {
      icon: "bi-speedometer",
      color: "secondary",
      settings: {
        app_version: { label: "App Version", description: "Current application version", type: :string },
        git_sha: { label: "Git SHA", description: "Deployed commit", type: :git_sha },
        git_repository_url: { label: "Git Repository URL", description: "GitHub/GitLab repo URL", type: :url },
        dashboard_base_url: { label: "Dashboard Base URL", description: "Base URL for dashboard links", type: :url }
      }
    },
    "Advanced Configuration" => {
      icon: "bi-sliders",
      color: "warning",
      settings: {
        custom_severity_rules: { label: "Custom Severity Rules", description: "Error type → severity mapping", type: :hash },
        ignored_exceptions: { label: "Ignored Exceptions", description: "Exceptions to ignore", type: :array }
      }
    },
    "Internal Logging" => {
      icon: "bi-terminal",
      color: "light",
      settings: {
        enable_internal_logging: { label: "Internal Logging", description: "Gem debugging output", type: :boolean },
        log_level: { label: "Log Level", description: "Verbosity level", type: :symbol, show_if: :enable_internal_logging }
      }
    }
  }
%>

<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-gear me-2"></i>
      Configuration Settings
    </h1>
    <div>
      <%= link_to root_path, class: "btn btn-outline-secondary btn-sm" do %>
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      <% end %>
    </div>
  </div>

  <div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Read-only view</strong> - These settings are configured in your initializer file:
    <code>config/initializers/rails_error_dashboard.rb</code>
  </div>

  <!-- Dynamically render setting groups -->
  <% setting_groups.each do |group_name, group_config| %>
    <div class="card mb-4">
      <div class="card-header bg-<%= group_config[:color] %> <%= group_config[:color] == 'light' ? 'text-dark' : 'text-white' %>">
        <h5 class="mb-0">
          <i class="<%= group_config[:icon] %>"></i> <%= group_name %>
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <% group_config[:settings].each do |setting_key, setting_meta| %>
            <%
              # Check if this setting should be displayed based on show_if condition
              show_if_key = setting_meta[:show_if]
              should_show = show_if_key.nil? || @config.send(show_if_key)
              next unless should_show

              value = @config.send(setting_key)
            %>
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= setting_meta[:label] %></strong>
                  <br><small class="text-muted"><%= setting_meta[:description] %></small>
                </div>
                <div class="text-end">
                  <%= render partial: 'rails_error_dashboard/errors/settings/value_badge',
                             locals: { value: value, type: setting_meta[:type], unit: setting_meta[:unit] } %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Active Plugins -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">
        <i class="bi bi-puzzle"></i> Active Plugins
      </h5>
    </div>
    <div class="card-body">
      <% if RailsErrorDashboard::PluginRegistry.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Plugin Name</th>
                <th>Version</th>
                <th>Description</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% RailsErrorDashboard::PluginRegistry.info.each do |plugin| %>
                <tr>
                  <td><strong><%= plugin[:name] %></strong></td>
                  <td><code><%= plugin[:version] %></code></td>
                  <td><%= plugin[:description] %></td>
                  <td>
                    <% if plugin[:enabled] %>
                      <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Active
                      </span>
                    <% else %>
                      <span class="badge bg-secondary">
                        <i class="bi bi-pause-circle"></i> Inactive
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-secondary mb-0">
          <i class="bi bi-info-circle me-2"></i>
          No plugins are currently registered. You can create custom plugins to extend functionality.
        </div>
      <% end %>
    </div>
  </div>

  <!-- Help Text -->
  <div class="alert alert-light border">
    <h6 class="alert-heading">
      <i class="bi bi-question-circle me-2"></i>
      Need to change these settings?
    </h6>
    <p class="mb-0">
      Edit your configuration in <code>config/initializers/rails_error_dashboard.rb</code> and restart your application.
      <br>
      See the <a href="https://github.com/AnjanJ/rails_error_dashboard" target="_blank" class="alert-link">documentation</a> for more information.
    </p>
  </div>
</div>
