<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <%= link_to errors_path, class: "btn btn-outline-secondary btn-sm mb-2" do %>
        <i class="bi bi-arrow-left"></i> Back to Errors
      <% end %>
      <h2 class="mb-0">
        Error Details
        <% severity = @error.severity %>
        <% if severity == :critical %>
          <span class="badge bg-danger fs-5">CRITICAL</span>
        <% elsif severity == :high %>
          <span class="badge bg-warning text-dark fs-5">HIGH</span>
        <% elsif severity == :medium %>
          <span class="badge bg-info text-dark fs-5">MEDIUM</span>
        <% else %>
          <span class="badge bg-secondary fs-5">LOW</span>
        <% end %>
      </h2>
    </div>
    <div>
      <% if @error.resolved? %>
        <span class="badge bg-success fs-6">
          <i class="bi bi-check-circle"></i> Resolved
        </span>
      <% else %>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#resolveModal">
          <i class="bi bi-check-circle"></i> Mark as Resolved
        </button>
      <% end %>
    </div>
  </div>

  <div class="row g-4">
    <!-- Error Information -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="bi bi-bug-fill"></i> <%= @error.error_type %></h5>
        </div>
        <div class="card-body">
          <h6 class="text-muted mb-3">Error Message:</h6>
          <div class="alert alert-danger">
            <%= @error.message %>
          </div>

          <h6 class="text-muted mb-2 mt-4">Backtrace:</h6>
          <% if @error.backtrace.present? %>
            <div class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
              <pre class="mb-0"><code><%= @error.backtrace %></code></pre>
            </div>
          <% else %>
            <p class="text-muted">No backtrace available</p>
          <% end %>
        </div>
      </div>

      <!-- Request Context -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-globe"></i> Request Context</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="200">Request URL:</th>
              <td><code><%= @error.request_url || 'N/A' %></code></td>
            </tr>
            <tr>
              <th>Request Params:</th>
              <td>
                <% if @error.request_params.present? %>
                  <pre class="mb-0"><code><%= JSON.pretty_generate(JSON.parse(@error.request_params)) rescue @error.request_params %></code></pre>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>User Agent:</th>
              <td><small><%= @error.user_agent || 'N/A' %></small></td>
            </tr>
            <tr>
              <th>IP Address:</th>
              <td><code><%= @error.ip_address || 'N/A' %></code></td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Similar Errors (Fuzzy Matching) - Phase 4.1.1 -->
      <% if @error.respond_to?(:similar_errors) %>
        <% similar = @error.similar_errors(threshold: 0.6, limit: 5) %>
        <% if similar.any? %>
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-diagram-3"></i> Similar Errors
                <span class="badge bg-info text-dark">Phase 4.1: Fuzzy Matching</span>
              </h5>
              <small class="text-muted">Errors with similar backtraces and messages (60%+ similarity)</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Similarity</th>
                      <th>Error Type</th>
                      <th>Message</th>
                      <th>Platform</th>
                      <th>Occurrences</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% similar.each do |item| %>
                      <% similar_error = item[:error] %>
                      <% similarity_pct = (item[:similarity] * 100).round %>
                      <tr>
                        <td>
                          <div class="progress" style="width: 60px; height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: <%= similarity_pct %>%"
                                 aria-valuenow="<%= similarity_pct %>"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                              <%= similarity_pct %>%
                            </div>
                          </div>
                        </td>
                        <td><code><%= similar_error.error_type %></code></td>
                        <td>
                          <div class="text-truncate" style="max-width: 300px;"
                               data-bs-toggle="tooltip"
                               title="<%= similar_error.message %>">
                            <%= similar_error.message %>
                          </div>
                        </td>
                        <td>
                          <% if similar_error.platform == 'iOS' %>
                            <span class="badge badge-ios">iOS</span>
                          <% elsif similar_error.platform == 'Android' %>
                            <span class="badge badge-android">Android</span>
                          <% else %>
                            <span class="badge badge-api"><%= similar_error.platform || 'API' %></span>
                          <% end %>
                        </td>
                        <td><span class="badge bg-primary"><%= similar_error.occurrence_count %>x</span></td>
                        <td>
                          <%= link_to "View", error_path(similar_error), class: "btn btn-sm btn-outline-primary" %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Phase 4.1.2: Co-occurring Errors -->
      <% if @error.respond_to?(:co_occurring_errors) %>
        <% co_occurring = @error.co_occurring_errors(window_minutes: 5, min_frequency: 2, limit: 5) %>
        <% if co_occurring.any? %>
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> Co-occurring Errors
                <span class="badge bg-info text-dark">Phase 4.1.2: Time Patterns</span>
              </h5>
              <small class="text-muted">Errors that occur within 5 minutes of this error</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Error Type</th>
                      <th>Message</th>
                      <th>Platform</th>
                      <th>Frequency</th>
                      <th>Avg Delay</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% co_occurring.each do |result| %>
                      <% error = result[:error] %>
                      <% frequency = result[:frequency] %>
                      <% avg_delay = result[:avg_delay_seconds] %>
                      <tr>
                        <td>
                          <span class="badge bg-danger"><%= error.error_type %></span>
                        </td>
                        <td>
                          <span data-bs-toggle="tooltip" title="<%= error.message %>">
                            <%= truncate(error.message, length: 60) %>
                          </span>
                        </td>
                        <td>
                          <% if error.platform.present? %>
                            <span class="badge bg-secondary"><%= error.platform %></span>
                          <% end %>
                        </td>
                        <td>
                          <span class="badge bg-info text-dark">
                            <%= frequency %> time<%= frequency > 1 ? 's' : '' %>
                          </span>
                        </td>
                        <td>
                          <% if avg_delay < 0 %>
                            <span class="text-warning"><%= number_to_human(avg_delay.abs, units: {unit: "s", thousand: "s"}, precision: 1) %> before</span>
                          <% elsif avg_delay > 0 %>
                            <span class="text-success"><%= number_to_human(avg_delay, units: {unit: "s", thousand: "s"}, precision: 1) %> after</span>
                          <% else %>
                            <span class="text-muted">simultaneous</span>
                          <% end %>
                        </td>
                        <td class="text-end">
                          <%= link_to "View", error_path(error), class: "btn btn-sm btn-outline-primary" %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Related Errors -->
      <% if @related_errors.any? %>
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-collection"></i> Related Errors</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Time</th>
                    <th>Message</th>
                    <th>Platform</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @related_errors.each do |related| %>
                    <tr>
                      <td><small><%= related.occurred_at.strftime("%m/%d %I:%M%p") %></small></td>
                      <td>
                        <div class="text-truncate" style="max-width: 400px;">
                          <%= related.message %>
                        </div>
                      </td>
                      <td>
                        <% if related.platform == 'iOS' %>
                          <span class="badge badge-ios">iOS</span>
                        <% elsif related.platform == 'Android' %>
                          <span class="badge badge-android">Android</span>
                        <% else %>
                          <span class="badge badge-api"><%= related.platform || 'API' %></span>
                        <% end %>
                      </td>
                      <td>
                        <% if related.resolved? %>
                          <i class="bi bi-check-circle-fill text-success"></i>
                        <% else %>
                          <i class="bi bi-exclamation-circle-fill text-danger"></i>
                        <% end %>
                      </td>
                      <td>
                        <%= link_to "View", error_path(related), class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Error Cascades (Phase 4.1.3) -->
      <% cascades = @error.error_cascades %>
      <% if cascades[:parents].any? || cascades[:children].any? %>
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-diagram-3"></i> Error Cascades
              <small class="text-muted ms-2">Causal relationships between errors</small>
            </h5>
          </div>
          <div class="card-body">
            <!-- Parent Errors (What causes this error) -->
            <% if cascades[:parents].any? %>
              <div class="mb-4">
                <h6 class="text-danger">
                  <i class="bi bi-arrow-down-circle"></i> Triggered By
                  <small class="text-muted">(errors that cause this one)</small>
                </h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Error Type</th>
                        <th>Message</th>
                        <th>Probability</th>
                        <th>Frequency</th>
                        <th>Avg Delay</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% cascades[:parents].each do |cascade| %>
                        <% parent = cascade[:error] %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= severity_color(parent.severity) %>">
                              <%= parent.error_type %>
                            </span>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 250px;">
                              <%= parent.message %>
                            </div>
                          </td>
                          <td>
                            <% probability_pct = (cascade[:probability] * 100).round(1) %>
                            <span class="badge <%= probability_pct >= 70 ? 'bg-danger' : 'bg-warning' %>">
                              <%= probability_pct %>%
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary"><%= cascade[:frequency] %>x</span>
                          </td>
                          <td>
                            <small class="text-muted">
                              <%= cascade[:avg_delay_seconds].round(1) %>s
                            </small>
                          </td>
                          <td>
                            <%= link_to "View", error_path(parent), class: "btn btn-sm btn-outline-primary" %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% end %>

            <!-- Child Errors (What this error causes) -->
            <% if cascades[:children].any? %>
              <div>
                <h6 class="text-warning">
                  <i class="bi bi-arrow-up-circle"></i> Triggers
                  <small class="text-muted">(errors caused by this one)</small>
                </h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Error Type</th>
                        <th>Message</th>
                        <th>Probability</th>
                        <th>Frequency</th>
                        <th>Avg Delay</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% cascades[:children].each do |cascade| %>
                        <% child = cascade[:error] %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= severity_color(child.severity) %>">
                              <%= child.error_type %>
                            </span>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 250px;">
                              <%= child.message %>
                            </div>
                          </td>
                          <td>
                            <% probability_pct = (cascade[:probability] * 100).round(1) %>
                            <span class="badge <%= probability_pct >= 70 ? 'bg-danger' : 'bg-warning' %>">
                              <%= probability_pct %>%
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary"><%= cascade[:frequency] %>x</span>
                          </td>
                          <td>
                            <small class="text-muted">
                              +<%= cascade[:avg_delay_seconds].round(1) %>s
                            </small>
                          </td>
                          <td>
                            <%= link_to "View", error_path(child), class: "btn btn-sm btn-outline-primary" %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% end %>

            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Cascade patterns show causal relationships. High probability (≥70%) and frequency (≥3) indicate strong cascades.
              </small>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Phase 4.5: Occurrence Patterns and Bursts -->
      <%= render "pattern_insights" %>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Metadata Card -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Metadata</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted d-block mb-1">Occurrence Count</small>
            <span class="badge bg-primary fs-5"><%= @error.occurrence_count %>x</span>
            <% if @error.occurrence_count > 1 %>
              <br><small class="text-muted">This error has occurred <%= @error.occurrence_count %> times</small>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">First Seen</small>
            <strong><%= @error.first_seen_at&.strftime("%B %d, %Y") || 'N/A' %></strong><br>
            <small><%= @error.first_seen_at&.strftime("%I:%M:%S %p %Z") || 'N/A' %></small>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Last Seen</small>
            <strong><%= @error.last_seen_at&.strftime("%B %d, %Y") || 'N/A' %></strong><br>
            <small><%= @error.last_seen_at&.strftime("%I:%M:%S %p %Z") || 'N/A' %></small>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Severity Level</small>
            <% severity = @error.severity %>
            <% if severity == :critical %>
              <span class="badge bg-danger fs-6">CRITICAL</span>
            <% elsif severity == :high %>
              <span class="badge bg-warning text-dark fs-6">HIGH</span>
            <% elsif severity == :medium %>
              <span class="badge bg-info text-dark fs-6">MEDIUM</span>
            <% else %>
              <span class="badge bg-secondary fs-6">LOW</span>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Platform</small>
            <% if @error.platform == 'iOS' %>
              <span class="badge badge-ios"><i class="bi bi-phone"></i> iOS</span>
            <% elsif @error.platform == 'Android' %>
              <span class="badge badge-android"><i class="bi bi-phone"></i> Android</span>
            <% else %>
              <span class="badge badge-api"><i class="bi bi-server"></i> <%= @error.platform || 'API' %></span>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">User</small>
            <% if @error.user %>
              <strong><%= @error.user.email %></strong><br>
              <small class="text-muted">ID: <%= @error.user_id %></small>
            <% else %>
              <span class="text-muted">Guest / Unauthenticated</span>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Status</small>
            <% if @error.resolved? %>
              <span class="badge bg-success">
                <i class="bi bi-check-circle"></i> Resolved
              </span>
              <% if @error.resolved_at.present? %>
                <br>
                <small class="text-muted mt-1 d-block">
                  <%= @error.resolved_at.strftime("%B %d, %Y at %I:%M %p") %>
                </small>
              <% end %>
            <% else %>
              <span class="badge bg-danger">
                <i class="bi bi-exclamation-circle"></i> Unresolved
              </span>
            <% end %>
          </div>

          <% if @error.resolved? && @error.resolved_by_name.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Resolved By</small>
              <strong><%= @error.resolved_by_name %></strong>
            </div>
          <% end %>

          <% if @error.resolved? && @error.resolution_reference.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Reference</small>
              <code><%= @error.resolution_reference %></code>
            </div>
          <% end %>

          <% if @error.resolved? && @error.resolution_comment.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Resolution Notes</small>
              <div class="alert alert-success mb-0">
                <%= simple_format(@error.resolution_comment) %>
              </div>
            </div>
          <% end %>

          <div>
            <small class="text-muted d-block mb-1">Error ID</small>
            <code><%= @error.id %></code>
          </div>
        </div>
      </div>

      <!-- Phase 4.2: Baseline Statistics -->
      <% baselines = @error.baselines %>
      <% if baselines[:hourly].present? || baselines[:daily].present? || baselines[:weekly].present? %>
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-graph-up"></i> Baseline Statistics
              <small class="text-muted ms-2">Historical patterns</small>
            </h5>
          </div>
          <div class="card-body">
            <% anomaly = @error.baseline_anomaly %>
            <% if anomaly[:anomaly] %>
              <div class="alert alert-<%= anomaly[:level] == :critical ? 'danger' : anomaly[:level] == :high ? 'warning' : 'info' %> mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>Anomaly Detected!</strong><br>
                <small>
                  This error is <%= anomaly[:std_devs_above]&.round(1) %>σ above baseline
                  (<%= anomaly[:level].to_s.upcase %>)
                </small>
              </div>
            <% end %>

            <% [:hourly, :daily, :weekly].each do |type| %>
              <% baseline = baselines[type] %>
              <% next unless baseline %>

              <div class="mb-3">
                <small class="text-muted d-block mb-1 text-capitalize">
                  <i class="bi bi-<%= type == :hourly ? 'clock' : type == :daily ? 'calendar-day' : 'calendar-week' %>"></i>
                  <%= type.to_s.capitalize %> Baseline
                </small>

                <div class="row g-2">
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">Mean</small>
                      <strong><%= baseline.mean&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">Std Dev</small>
                      <strong><%= baseline.std_dev&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">95th %</small>
                      <strong><%= baseline.percentile_95&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">99th %</small>
                      <strong><%= baseline.percentile_99&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                </div>

                <% if baseline.mean && baseline.std_dev %>
                  <div class="mt-2">
                    <small class="text-muted">
                      Threshold (2σ): <strong><%= baseline.threshold(sensitivity: 2)&.round(1) %></strong>
                    </small>
                  </div>
                <% end %>

                <div class="mt-2">
                  <small class="text-muted">
                    Sample: <%= baseline.sample_size %> periods
                    <span class="text-muted">|</span>
                    Updated: <%= baseline.updated_at&.strftime("%m/%d %I:%M%p") %>
                  </small>
                </div>
              </div>

              <% unless baseline == baselines.values.compact.last %>
                <hr>
              <% end %>
            <% end %>

            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Baselines establish "normal" error rates. Anomalies are detected when current rates exceed baseline + 2σ.
              </small>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to errors_path(error_type: @error.error_type), class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-filter"></i> View Similar Errors
            <% end %>

            <% if @error.user %>
              <%= link_to errors_path(user_id: @error.user_id), class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-person"></i> View User's Errors
              <% end %>
            <% end %>

            <%= link_to errors_path(platform: @error.platform), class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-phone"></i> View <%= @error.platform %> Errors
            <% end %>

            <%= link_to analytics_errors_path, class: "btn btn-outline-secondary btn-sm" do %>
              <i class="bi bi-graph-up"></i> View Analytics
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Resolve Error Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" aria-labelledby="resolveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: resolve_error_path(@error), method: :patch, class: "modal-content" do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="resolveModalLabel">
            <i class="bi bi-check-circle"></i> Mark Error as Resolved
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="resolved_by_name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <%= text_field_tag :resolved_by_name, nil, class: "form-control", placeholder: "e.g., John Doe", required: true %>
            <small class="text-muted">Who is resolving this error?</small>
          </div>

          <div class="mb-3">
            <label for="resolution_reference" class="form-label">Reference (Optional)</label>
            <%= text_field_tag :resolution_reference, nil, class: "form-control", placeholder: "e.g., JIRA-123, PR #456, GitHub Issue #789" %>
            <small class="text-muted">Link to ticket, PR, or issue</small>
          </div>

          <div class="mb-3">
            <label for="resolution_comment" class="form-label">Resolution Notes (Optional)</label>
            <%= text_area_tag :resolution_comment, nil, class: "form-control", rows: 4, placeholder: "Describe what was done to fix this error..." %>
            <small class="text-muted">What was done to resolve this error?</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= submit_tag "Mark as Resolved", class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
