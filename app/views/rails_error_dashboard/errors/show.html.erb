<% content_for :page_title, "Error ##{@error.id}" %>

<div class="py-4">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to root_path do %><i class="bi bi-house-door"></i> Dashboard<% end %></li>
      <li class="breadcrumb-item"><%= link_to errors_path do %><i class="bi bi-bug"></i> Errors<% end %></li>
      <li class="breadcrumb-item active" aria-current="page">Error #<%= @error.id %></li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">
        Error Details
        <% severity = @error.severity %>
        <% if severity == :critical %>
          <span class="badge bg-danger fs-5">CRITICAL</span>
        <% elsif severity == :high %>
          <span class="badge bg-warning text-dark fs-5">HIGH</span>
        <% elsif severity == :medium %>
          <span class="badge bg-info text-dark fs-5">MEDIUM</span>
        <% else %>
          <span class="badge bg-secondary fs-5">LOW</span>
        <% end %>
      </h2>
    </div>
    <div>
      <% if @error.resolved? %>
        <span class="badge bg-success fs-6">
          <i class="bi bi-check-circle"></i> Resolved
        </span>
      <% else %>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#resolveModal">
          <i class="bi bi-check-circle"></i> Mark as Resolved
        </button>
      <% end %>
    </div>
  </div>

  <div class="row g-4">
    <!-- Error Information -->
    <div class="col-md-8">
      <% cache [@error, 'error_details_v1'] do %>
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-bug-fill"></i> <%= @error.error_type %>
              <% if @error.recent? %>
                <span class="badge bg-success ms-2" data-bs-toggle="tooltip" title="Error occurred within the last hour">NEW</span>
              <% end %>
            </h5>
            <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard('<%= j @error.error_type %>', this)" title="Copy error type">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted mb-0">Error Message:</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= j @error.message %>', this)" title="Copy error message">
              <i class="bi bi-clipboard"></i> Copy
            </button>
          </div>
          <div class="alert alert-danger">
            <%= @error.message %>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
            <h6 class="text-muted mb-0">
              Backtrace:
              <% if @error.backtrace.present? %>
                <% frames = parse_backtrace(@error.backtrace) %>
                <% app_frames = filter_app_code(frames) %>
                <% framework_frames = filter_framework_code(frames) %>
                <small class="text-muted">
                  (<%= app_frames.count %> your code, <%= framework_frames.count %> framework/gems)
                </small>
              <% end %>
            </h6>
            <% if @error.backtrace.present? %>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(`<%= j @error.backtrace %>`, this)" title="Copy full backtrace">
                <i class="bi bi-clipboard"></i> Copy Full Backtrace
              </button>
            <% end %>
          </div>
          <% if @error.backtrace.present? %>
            <% frames = parse_backtrace(@error.backtrace) %>
            <% app_frames = filter_app_code(frames) %>
            <% framework_frames = filter_framework_code(frames) %>

            <% if app_frames.any? %>
              <!-- Your Code Section (Expanded by default) -->
              <div class="card mb-3">
                <div class="card-header bg-success bg-opacity-10 border-success">
                  <div class="d-flex justify-content-between align-items-center">
                    <strong class="text-success">
                      <i class="bi bi-code-square"></i> Your Code
                    </strong>
                    <span class="badge bg-success"><%= app_frames.count %> frames</span>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="code-block p-3" style="max-height: 300px; overflow-y: auto; overflow-x: auto;">
                    <pre class="mb-0"><code><% app_frames.each do |frame| %><span class="<%= frame_bg_class(frame[:category]) %> d-block px-2 py-1"><span class="<%= frame_color_class(frame[:category]) %>"><%= frame_icon(frame[:category]) %> <%= frame[:short_path] %>:<%= frame[:line_number] %></span> in <span class="text-info">`<%= frame[:method_name] %>'</span></span>
<% end %></code></pre>
                  </div>
                </div>
              </div>
            <% end %>

            <% if framework_frames.any? %>
              <!-- Framework/Gem Code Section (Collapsed by default) -->
              <div class="accordion" id="frameworkBacktraceAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#frameworkBacktrace" aria-expanded="false" aria-controls="frameworkBacktrace">
                      <i class="bi bi-gear me-2 text-warning"></i>
                      <strong>Framework & Gem Code</strong>
                      <span class="badge bg-secondary ms-2"><%= framework_frames.count %> frames</span>
                      <small class="text-muted ms-2">(click to expand)</small>
                    </button>
                  </h2>
                  <div id="frameworkBacktrace" class="accordion-collapse collapse" data-bs-parent="#frameworkBacktraceAccordion">
                    <div class="accordion-body p-0">
                      <div class="code-block p-3" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <pre class="mb-0"><code><% framework_frames.each do |frame| %><span class="<%= frame_bg_class(frame[:category]) %> d-block px-2 py-1"><span class="<%= frame_color_class(frame[:category]) %>"><%= frame_icon(frame[:category]) %> <%= frame[:short_path] %>:<%= frame[:line_number] %></span> in <span class="text-info">`<%= frame[:method_name] %>'</span></span>
<% end %></code></pre>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>

            <% if app_frames.empty? && framework_frames.empty? %>
              <!-- Fallback: Show raw backtrace if parsing failed -->
              <div class="code-block p-3 rounded" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                <pre class="mb-0"><code><%= @error.backtrace %></code></pre>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted">No backtrace available</p>
          <% end %>
        </div>
      </div>
      <% end %>

      <!-- Request Context -->
      <% cache [@error, 'request_context_v1'] do %>
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-globe"></i> Request Context</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="200">Request URL:</th>
              <td><code><%= @error.request_url || 'N/A' %></code></td>
            </tr>
            <tr>
              <th>Request Params:</th>
              <td>
                <% if @error.request_params.present? %>
                  <pre class="mb-0"><code><%= JSON.pretty_generate(JSON.parse(@error.request_params)) rescue @error.request_params %></code></pre>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>User Agent:</th>
              <td>
                <% if @error.user_agent.present? %>
                  <% ua_info = parse_user_agent(@error.user_agent) %>
                  <div class="mb-2">
                    <%= browser_icon(ua_info) %>
                    <strong><%= ua_info[:browser_name] %></strong>
                    <% if ua_info[:browser_version].present? %>
                      <span class="text-muted"><%= ua_info[:browser_version] %></span>
                    <% end %>
                    <span class="ms-2"><%= os_icon(ua_info) %> <%= ua_info[:os_name] %></span>
                    <span class="ms-2"><%= device_icon(ua_info) %> <%= ua_info[:device_type] %></span>
                  </div>
                  <details>
                    <summary class="text-muted" style="cursor: pointer;">
                      <small>Raw User Agent</small>
                    </summary>
                    <small class="text-muted"><%= @error.user_agent %></small>
                  </details>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>IP Address:</th>
              <td><code><%= @error.ip_address || 'N/A' %></code></td>
            </tr>
          </table>
        </div>
      </div>
      <% end %>

      <!-- Similar Errors (Fuzzy Matching) -->
      <% if RailsErrorDashboard.configuration.enable_similar_errors && @error.respond_to?(:similar_errors) %>
        <% similar = @error.similar_errors(threshold: 0.6, limit: 5) %>
        <% if similar.any? %>
          <% cache [@error, 'similar_errors_v1', similar.map { |s| s[:error]&.updated_at }.compact.max] do %>
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-diagram-3"></i> Similar Errors
                <span class="badge bg-info text-dark">Fuzzy Matching</span>
              </h5>
              <small class="text-muted">Errors with similar backtraces and messages (60%+ similarity)</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Similarity</th>
                      <th>Error Type</th>
                      <th>Message</th>
                      <th>Platform</th>
                      <th>Occurrences</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% similar.each do |item| %>
                      <% similar_error = item[:error] %>
                      <% similarity_pct = (item[:similarity] * 100).round %>
                      <tr>
                        <td>
                          <div class="progress" style="width: 60px; height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: <%= similarity_pct %>%"
                                 aria-valuenow="<%= similarity_pct %>"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                              <%= similarity_pct %>%
                            </div>
                          </div>
                        </td>
                        <td><code><%= similar_error.error_type %></code></td>
                        <td>
                          <div class="text-truncate" style="max-width: 300px;"
                               data-bs-toggle="tooltip"
                               title="<%= similar_error.message %>">
                            <%= similar_error.message %>
                          </div>
                        </td>
                        <td>
                          <% if similar_error.platform == 'iOS' %>
                            <span class="badge badge-ios"><i class="bi bi-apple"></i> iOS</span>
                          <% elsif similar_error.platform == 'Android' %>
                            <span class="badge badge-android"><i class="bi bi-android2"></i> Android</span>
                          <% elsif similar_error.platform == 'Web' %>
                            <span class="badge badge-web"><i class="bi bi-globe"></i> Web</span>
                          <% else %>
                            <span class="badge badge-api"><i class="bi bi-server"></i> <%= similar_error.platform || 'API' %></span>
                          <% end %>
                        </td>
                        <td><span class="badge bg-primary"><%= similar_error.occurrence_count %>x</span></td>
                        <td>
                          <%= link_to "View", error_path(similar_error), class: "btn btn-sm btn-outline-primary" %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <% end %>
        <% end %>
      <% end %>

      <!-- Co-occurring Errors -->
      <% if RailsErrorDashboard.configuration.enable_co_occurring_errors && @error.respond_to?(:co_occurring_errors) %>
        <% co_occurring = @error.co_occurring_errors(window_minutes: 5, min_frequency: 2, limit: 5) %>
        <% if co_occurring.any? %>
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> Co-occurring Errors
                <span class="badge bg-info text-dark">Time Patterns</span>
              </h5>
              <small class="text-muted">Errors that occur within 5 minutes of this error</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Error Type</th>
                      <th>Message</th>
                      <th>Platform</th>
                      <th>Frequency</th>
                      <th>Avg Delay</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% co_occurring.each do |result| %>
                      <% error = result[:error] %>
                      <% frequency = result[:frequency] %>
                      <% avg_delay = result[:avg_delay_seconds] %>
                      <tr>
                        <td>
                          <span class="badge bg-danger"><%= error.error_type %></span>
                        </td>
                        <td>
                          <span data-bs-toggle="tooltip" title="<%= error.message %>">
                            <%= truncate(error.message, length: 60) %>
                          </span>
                        </td>
                        <td>
                          <% if error.platform.present? %>
                            <span class="badge bg-secondary"><%= error.platform %></span>
                          <% end %>
                        </td>
                        <td>
                          <span class="badge bg-info text-dark">
                            <%= frequency %> time<%= frequency > 1 ? 's' : '' %>
                          </span>
                        </td>
                        <td>
                          <% if avg_delay < 0 %>
                            <span class="text-warning"><%= number_to_human(avg_delay.abs, units: {unit: "s", thousand: "s"}, precision: 1) %> before</span>
                          <% elsif avg_delay > 0 %>
                            <span class="text-success"><%= number_to_human(avg_delay, units: {unit: "s", thousand: "s"}, precision: 1) %> after</span>
                          <% else %>
                            <span class="text-muted">simultaneous</span>
                          <% end %>
                        </td>
                        <td class="text-end">
                          <%= link_to "View", error_path(error), class: "btn btn-sm btn-outline-primary" %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Timeline: Related Errors -->
      <%= render "timeline" %>

      <!-- Phase 3: Comment Threads -->
      <% if @error.respond_to?(:comments) %>
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-chat-dots"></i> Discussion
              <span class="badge bg-secondary ms-2"><%= @error.comments.count %></span>
            </h5>
          </div>
          <div class="card-body">
            <!-- Existing Comments -->
            <% if @error.comments.recent_first.any? %>
              <div class="mb-4">
                <% @error.comments.recent_first.each do |comment| %>
                  <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <strong class="text-primary">
                          <i class="bi bi-person-circle"></i> <%= comment.author_name %>
                        </strong>
                        <% if comment.recent? %>
                          <span class="badge bg-success ms-2">New</span>
                        <% end %>
                      </div>
                      <small class="text-muted">
                        <%= comment.formatted_time %>
                        <span class="ms-1 text-muted">(<%= time_ago_in_words(comment.created_at) %> ago)</span>
                      </small>
                    </div>
                    <div class="text-break">
                      <%= simple_format(comment.body, class: "mb-0") %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="text-muted mb-4">
                <i class="bi bi-info-circle"></i> No comments yet. Start the discussion below.
              </p>
            <% end %>

            <!-- Add Comment Form -->
            <div class="border-top pt-3">
              <h6 class="mb-3">
                <i class="bi bi-plus-circle"></i> Add Comment
              </h6>
              <%= form_with url: add_comment_error_path(@error), method: :post do |f| %>
                <div class="mb-3">
                  <label for="author_name" class="form-label">Your Name <span class="text-danger">*</span></label>
                  <%= text_field_tag :author_name, @error.assigned_to, class: "form-control", placeholder: "e.g., John Doe", required: true %>
                </div>
                <div class="mb-3">
                  <label for="body" class="form-label">Comment <span class="text-danger">*</span></label>
                  <%= text_area_tag :body, nil, class: "form-control", rows: 4, placeholder: "Share your thoughts, findings, or updates...", required: true %>
                </div>
                <%= submit_tag "Post Comment", class: "btn btn-primary" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Error Cascades -->
      <% if RailsErrorDashboard.configuration.enable_error_cascades %>
        <% cascades = @error.error_cascades %>
        <% if cascades[:parents].any? || cascades[:children].any? %>
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-diagram-3"></i> Error Cascades
              <small class="text-muted ms-2">Causal relationships between errors</small>
            </h5>
          </div>
          <div class="card-body">
            <!-- Parent Errors (What causes this error) -->
            <% if cascades[:parents].any? %>
              <div class="mb-4">
                <h6 class="text-danger">
                  <i class="bi bi-arrow-down-circle"></i> Triggered By
                  <small class="text-muted">(errors that cause this one)</small>
                </h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Error Type</th>
                        <th>Message</th>
                        <th>Probability</th>
                        <th>Frequency</th>
                        <th>Avg Delay</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% cascades[:parents].each do |cascade| %>
                        <% parent = cascade[:error] %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= severity_color(parent.severity) %>">
                              <%= parent.error_type %>
                            </span>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 250px;">
                              <%= parent.message %>
                            </div>
                          </td>
                          <td>
                            <% probability_pct = (cascade[:probability] * 100).round(1) %>
                            <span class="badge <%= probability_pct >= 70 ? 'bg-danger' : 'bg-warning' %>">
                              <%= probability_pct %>%
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary"><%= cascade[:frequency] %>x</span>
                          </td>
                          <td>
                            <small class="text-muted">
                              <%= cascade[:avg_delay_seconds].round(1) %>s
                            </small>
                          </td>
                          <td>
                            <%= link_to "View", error_path(parent), class: "btn btn-sm btn-outline-primary" %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% end %>

            <!-- Child Errors (What this error causes) -->
            <% if cascades[:children].any? %>
              <div>
                <h6 class="text-warning">
                  <i class="bi bi-arrow-up-circle"></i> Triggers
                  <small class="text-muted">(errors caused by this one)</small>
                </h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Error Type</th>
                        <th>Message</th>
                        <th>Probability</th>
                        <th>Frequency</th>
                        <th>Avg Delay</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% cascades[:children].each do |cascade| %>
                        <% child = cascade[:error] %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= severity_color(child.severity) %>">
                              <%= child.error_type %>
                            </span>
                          </td>
                          <td>
                            <div class="text-truncate" style="max-width: 250px;">
                              <%= child.message %>
                            </div>
                          </td>
                          <td>
                            <% probability_pct = (cascade[:probability] * 100).round(1) %>
                            <span class="badge <%= probability_pct >= 70 ? 'bg-danger' : 'bg-warning' %>">
                              <%= probability_pct %>%
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary"><%= cascade[:frequency] %>x</span>
                          </td>
                          <td>
                            <small class="text-muted">
                              +<%= cascade[:avg_delay_seconds].round(1) %>s
                            </small>
                          </td>
                          <td>
                            <%= link_to "View", error_path(child), class: "btn btn-sm btn-outline-primary" %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% end %>

            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Cascade patterns show causal relationships. High probability (≥70%) and frequency (≥3) indicate strong cascades.
              </small>
            </div>
          </div>
        </div>
        <% end %>
      <% end %>

      <!-- Occurrence Patterns and Bursts -->
      <%= render "pattern_insights" %>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Metadata Card -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Metadata</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted d-block mb-1">Occurrence Count</small>
            <span class="badge bg-primary fs-5"><%= @error.occurrence_count %>x</span>
            <% if @error.occurrence_count > 1 %>
              <br><small class="text-muted">This error has occurred <%= @error.occurrence_count %> times</small>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">First Seen</small>
            <strong><%= @error.first_seen_at&.strftime("%B %d, %Y") || 'N/A' %></strong><br>
            <small><%= @error.first_seen_at&.strftime("%I:%M:%S %p %Z") || 'N/A' %></small>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Last Seen</small>
            <strong><%= @error.last_seen_at&.strftime("%B %d, %Y") || 'N/A' %></strong><br>
            <small><%= @error.last_seen_at&.strftime("%I:%M:%S %p %Z") || 'N/A' %></small>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Severity Level</small>
            <% severity = @error.severity %>
            <% if severity == :critical %>
              <span class="badge bg-danger fs-6">CRITICAL</span>
            <% elsif severity == :high %>
              <span class="badge bg-warning text-dark fs-6">HIGH</span>
            <% elsif severity == :medium %>
              <span class="badge bg-info text-dark fs-6">MEDIUM</span>
            <% else %>
              <span class="badge bg-secondary fs-6">LOW</span>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">Platform</small>
            <% if @error.platform == 'iOS' %>
              <span class="badge badge-ios"><i class="bi bi-apple"></i> iOS</span>
            <% elsif @error.platform == 'Android' %>
              <span class="badge badge-android"><i class="bi bi-android2"></i> Android</span>
            <% elsif @error.platform == 'Web' %>
              <span class="badge badge-web"><i class="bi bi-globe"></i> Web</span>
            <% else %>
              <span class="badge badge-api"><i class="bi bi-server"></i> <%= @error.platform || 'API' %></span>
            <% end %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block mb-1">User</small>
            <% if @error.respond_to?(:user) && @error.user %>
              <strong><%= @error.user.email %></strong><br>
              <small class="text-muted">ID: <%= @error.user_id %></small>
            <% elsif @error.user_id %>
              <span class="text-muted">User ID: <%= @error.user_id %></span>
            <% else %>
              <span class="text-muted">Guest / Unauthenticated</span>
            <% end %>
          </div>

          <!-- Phase 3: Workflow Status -->
          <div class="mb-3">
            <small class="text-muted d-block mb-1">Workflow Status</small>
            <% if @error.respond_to?(:status) %>
              <span class="badge bg-<%= @error.status_badge_color %> fs-6">
                <%= @error.status.titleize %>
              </span>
            <% elsif @error.resolved? %>
              <span class="badge bg-success">
                <i class="bi bi-check-circle"></i> Resolved
              </span>
              <% if @error.resolved_at.present? %>
                <br>
                <small class="text-muted mt-1 d-block">
                  <%= @error.resolved_at.strftime("%B %d, %Y at %I:%M %p") %>
                </small>
              <% end %>
            <% else %>
              <span class="badge bg-danger">
                <i class="bi bi-exclamation-circle"></i> Unresolved
              </span>
            <% end %>
          </div>

          <!-- Phase 3: Assignment -->
          <% if @error.respond_to?(:assigned_to) %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Assigned To</small>
              <% if @error.assigned? %>
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <i class="bi bi-person-fill text-primary"></i>
                    <strong><%= @error.assigned_to %></strong>
                    <% if @error.assigned_at.present? %>
                      <br>
                      <small class="text-muted">
                        <%= time_ago_in_words(@error.assigned_at) %> ago
                      </small>
                    <% end %>
                  </div>
                  <%= button_to unassign_error_path(@error), method: :patch, class: "btn btn-sm btn-outline-secondary",
                      data: { turbo_confirm: "Remove assignment?" } do %>
                    <i class="bi bi-x"></i>
                  <% end %>
                </div>
              <% else %>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                  <i class="bi bi-person-plus"></i> Assign
                </button>
              <% end %>
            </div>

            <!-- Phase 3: Priority -->
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Priority</small>
              <% if @error.respond_to?(:priority_level) %>
                <span class="badge bg-<%= @error.priority_color %> fs-6">
                  <%= @error.priority_label %>
                </span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#priorityModal">
                  <i class="bi bi-pencil"></i>
                </button>
              <% end %>
            </div>

            <!-- Phase 3: Snooze -->
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Snooze</small>
              <% if @error.respond_to?(:snoozed?) && @error.snoozed? %>
                <div class="alert alert-warning py-2 mb-2">
                  <i class="bi bi-alarm"></i>
                  <strong>Snoozed</strong><br>
                  <small>Until <%= @error.snoozed_until&.strftime("%b %d at %I:%M %p") %></small>
                </div>
                <%= button_to unsnooze_error_path(@error), method: :patch, class: "btn btn-sm btn-outline-warning" do %>
                  <i class="bi bi-alarm-fill"></i> Unsnooze
                <% end %>
              <% else %>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#snoozeModal">
                  <i class="bi bi-alarm"></i> Snooze
                </button>
              <% end %>
            </div>
          <% end %>

          <% if @error.resolved? && @error.resolved_by_name.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Resolved By</small>
              <strong><%= @error.resolved_by_name %></strong>
            </div>
          <% end %>

          <% if @error.resolved? && @error.resolution_reference.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Reference</small>
              <code><%= @error.resolution_reference %></code>
            </div>
          <% end %>

          <% if @error.resolved? && @error.resolution_comment.present? %>
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Resolution Notes</small>
              <div class="alert alert-success mb-0">
                <%= simple_format(@error.resolution_comment) %>
              </div>
            </div>
          <% end %>

          <!-- Environment Information -->
          <div class="mb-3">
            <small class="text-muted d-block mb-2">
              <i class="bi bi-gear"></i> Environment
            </small>

            <% if @error.app_version.present? %>
              <div class="mb-1">
                <small class="text-muted">App Version:</small>
                <code class="ms-1"><%= @error.app_version %></code>
              </div>
            <% end %>

            <% if @error.git_sha.present? %>
              <div class="mb-1">
                <small class="text-muted">Git SHA:</small>
                <span class="ms-1"><%= git_commit_link(@error.git_sha) %></span>
              </div>
            <% end %>

            <div class="mb-1">
              <small class="text-muted">Rails:</small>
              <code class="ms-1"><%= Rails.version %></code>
            </div>

            <div class="mb-1">
              <small class="text-muted">Ruby:</small>
              <code class="ms-1"><%= RUBY_VERSION %></code>
            </div>

            <div class="mb-1">
              <small class="text-muted">Environment:</small>
              <span class="badge bg-<%= Rails.env.production? ? 'danger' : Rails.env.development? ? 'success' : 'warning' %> ms-1">
                <%= Rails.env.titleize %>
              </span>
            </div>
          </div>

          <div>
            <small class="text-muted d-block mb-1">Error ID</small>
            <div class="d-flex align-items-center gap-2">
              <code><%= @error.id %></code>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= @error.id %>', this)" title="Copy error ID">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Baseline Statistics -->
      <% if RailsErrorDashboard.configuration.enable_baseline_alerts %>
        <% baselines = @error.baselines %>
        <% if baselines[:hourly].present? || baselines[:daily].present? || baselines[:weekly].present? %>
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-graph-up"></i> Baseline Statistics
              <small class="text-muted ms-2">Historical patterns</small>
            </h5>
          </div>
          <div class="card-body">
            <% anomaly = @error.baseline_anomaly %>
            <% if anomaly[:anomaly] %>
              <div class="alert alert-<%= anomaly[:level] == :critical ? 'danger' : anomaly[:level] == :high ? 'warning' : 'info' %> mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>Anomaly Detected!</strong><br>
                <small>
                  This error is <%= anomaly[:std_devs_above]&.round(1) %>σ above baseline
                  (<%= anomaly[:level].to_s.upcase %>)
                </small>
              </div>
            <% end %>

            <% [:hourly, :daily, :weekly].each do |type| %>
              <% baseline = baselines[type] %>
              <% next unless baseline %>

              <div class="mb-3">
                <small class="text-muted d-block mb-1 text-capitalize">
                  <i class="bi bi-<%= type == :hourly ? 'clock' : type == :daily ? 'calendar-day' : 'calendar-week' %>"></i>
                  <%= type.to_s.capitalize %> Baseline
                </small>

                <div class="row g-2">
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">Mean</small>
                      <strong><%= baseline.mean&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">Std Dev</small>
                      <strong><%= baseline.std_dev&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">95th %</small>
                      <strong><%= baseline.percentile_95&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                      <small class="text-muted d-block">99th %</small>
                      <strong><%= baseline.percentile_99&.round(1) || 'N/A' %></strong>
                    </div>
                  </div>
                </div>

                <% if baseline.respond_to?(:mean) && baseline.mean && baseline.respond_to?(:std_dev) && baseline.std_dev %>
                  <div class="mt-2">
                    <small class="text-muted">
                      Threshold (2σ): <strong><%= baseline.respond_to?(:threshold) ? baseline.threshold(sensitivity: 2)&.round(1) : 'N/A' %></strong>
                    </small>
                  </div>
                <% end %>

                <div class="mt-2">
                  <small class="text-muted">
                    Sample: <%= baseline.respond_to?(:sample_size) ? baseline.sample_size : 'N/A' %> periods
                    <span class="text-muted">|</span>
                    Updated: <%= baseline.respond_to?(:updated_at) ? baseline.updated_at&.strftime("%m/%d %I:%M%p") : 'N/A' %>
                  </small>
                </div>
              </div>

              <% unless baseline == baselines.values.compact.last %>
                <hr>
              <% end %>
            <% end %>

            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Baselines establish "normal" error rates. Anomalies are detected when current rates exceed baseline + 2σ.
              </small>
            </div>
          </div>
        </div>
        <% end %>
      <% end %>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to errors_path(error_type: @error.error_type), class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-filter"></i> View Similar Errors
            <% end %>

            <% if @error.user_id %>
              <%= link_to errors_path(user_id: @error.user_id), class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-person"></i> View User's Errors
              <% end %>
            <% end %>

            <%= link_to errors_path(platform: @error.platform), class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-phone"></i> View <%= @error.platform %> Errors
            <% end %>

            <%= link_to analytics_errors_path, class: "btn btn-outline-secondary btn-sm" do %>
              <i class="bi bi-graph-up"></i> View Analytics
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Resolve Error Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" aria-labelledby="resolveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: resolve_error_path(@error), method: :post, class: "modal-content" do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="resolveModalLabel">
            <i class="bi bi-check-circle"></i> Mark Error as Resolved
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="resolved_by_name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <%= text_field_tag :resolved_by_name, nil, class: "form-control", placeholder: "e.g., John Doe", required: true %>
            <small class="text-muted">Who is resolving this error?</small>
          </div>

          <div class="mb-3">
            <label for="resolution_reference" class="form-label">Reference (Optional)</label>
            <%= text_field_tag :resolution_reference, nil, class: "form-control", placeholder: "e.g., JIRA-123, PR #456, GitHub Issue #789" %>
            <small class="text-muted">Link to ticket, PR, or issue</small>
          </div>

          <div class="mb-3">
            <label for="resolution_comment" class="form-label">Resolution Notes (Optional)</label>
            <%= text_area_tag :resolution_comment, nil, class: "form-control", rows: 4, placeholder: "Describe what was done to fix this error..." %>
            <small class="text-muted">What was done to resolve this error?</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= submit_tag "Mark as Resolved", class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Phase 3: Assignment Modal -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: assign_error_path(@error), method: :patch do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="assignModalLabel">
            <i class="bi bi-person-plus"></i> Assign Error
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="assigned_to" class="form-label">Assign To <span class="text-danger">*</span></label>
            <%= text_field_tag :assigned_to, nil, class: "form-control", placeholder: "e.g., John Doe", required: true, autofocus: true %>
            <small class="text-muted">Who should investigate this error?</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= submit_tag "Assign", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Phase 3: Priority Modal -->
<div class="modal fade" id="priorityModal" tabindex="-1" aria-labelledby="priorityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: update_priority_error_path(@error), method: :patch do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="priorityModalLabel">
            <i class="bi bi-flag"></i> Update Priority
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="priority_level" class="form-label">Priority Level <span class="text-danger">*</span></label>
            <%= select_tag :priority_level,
                options_for_select([
                  ['Critical (P3)', 3],
                  ['High (P2)', 2],
                  ['Medium (P1)', 1],
                  ['Low (P0)', 0]
                ], @error.priority_level),
                class: "form-select", required: true %>
            <small class="text-muted">Current: <%= @error.priority_label %></small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= submit_tag "Update Priority", class: "btn btn-warning" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Phase 3: Snooze Modal -->
<div class="modal fade" id="snoozeModal" tabindex="-1" aria-labelledby="snoozeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: snooze_error_path(@error), method: :patch do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="snoozeModalLabel">
            <i class="bi bi-alarm"></i> Snooze Error
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="hours" class="form-label">Snooze Duration <span class="text-danger">*</span></label>
            <%= select_tag :hours,
                options_for_select([
                  ['1 hour', 1],
                  ['4 hours', 4],
                  ['8 hours', 8],
                  ['24 hours (1 day)', 24],
                  ['48 hours (2 days)', 48],
                  ['168 hours (1 week)', 168]
                ], 24),
                class: "form-select", required: true %>
            <small class="text-muted">Hide this error from active views</small>
          </div>

          <div class="mb-3">
            <label for="reason" class="form-label">Reason (Optional)</label>
            <%= text_area_tag :reason, nil, class: "form-control", rows: 3, placeholder: "Why are you snoozing this error?" %>
            <small class="text-muted">Reason will be added as a comment</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= submit_tag "Snooze", class: "btn btn-warning" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
