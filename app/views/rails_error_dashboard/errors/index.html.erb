<% content_for :page_title, "Errors" %>

<!-- Subscribe to Turbo Stream updates (only if ActionCable is available) -->
<% if defined?(ActionCable) %>
  <%= turbo_stream_from "error_list" %>
<% end %>

<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-bug-fill text-primary"></i> Error Overview</h2>
    <div class="text-muted">
      <small>
        Last updated: <%= local_time(Time.current, format: :full) %>
        <span class="badge bg-success ms-2" id="live-indicator">
          <i class="bi bi-broadcast"></i> Live
        </span>
      </small>
    </div>
  </div>

  <!-- Stats Cards -->
  <div id="dashboard_stats" class="mb-4">
    <%= render "stats", stats: @stats %>
  </div>

  <!-- Top Error Types (Only show if there are errors) -->
  <% if @stats[:top_errors].any? %>
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">Top Error Types</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% @stats[:top_errors].first(5).each do |error_type, count| %>
                <div class="col-md-2">
                  <div class="text-center p-3 border rounded">
                    <div class="fw-bold text-danger" style="font-size: 1.5rem;"><%= count %></div>
                    <small class="text-muted text-truncate d-block" title="<%= error_type %>"><%= error_type.split('::').last %></small>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Spike Detection Alert -->
  <% if @stats[:spike_detected] %>
    <div class="alert alert-warning mb-4" role="alert">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
        <div>
          <h5 class="alert-heading mb-1">
            <% case @stats[:spike_info][:severity] %>
            <% when :critical %>
              üö® Critical Error Spike Detected!
            <% when :high %>
              ‚ö†Ô∏è High Error Spike Detected
            <% when :elevated %>
              üìà Elevated Error Activity
            <% end %>
          </h5>
          <p class="mb-0">
            Today: <strong><%= @stats[:spike_info][:today_count] %> errors</strong>
            (7-day avg: <%= @stats[:spike_info][:avg_count] %>) ‚Äî
            <strong><%= @stats[:spike_info][:multiplier] %>x normal levels</strong>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- 7-Day Error Trend -->
  <% if @stats[:errors_trend_7d]&.any? %>
    <div class="row g-4 mb-4">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> 7-Day Error Trend</h5>
            <%= link_to analytics_errors_path, class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-bar-chart"></i> Full Analytics
            <% end %>
          </div>
          <div class="card-body">
            <%= line_chart @stats[:errors_trend_7d],
                color: "#8B5CF6",
                curve: false,
                points: true,
                height: "250px",
                library: {
                  plugins: {
                    legend: { display: false }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: { precision: 0 }
                    }
                  }
                } %>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> By Severity (7d)</h5>
          </div>
          <div class="card-body">
            <%= pie_chart @stats[:errors_by_severity_7d],
                colors: ["#EF4444", "#F59E0B", "#3B82F6", "#6B7280"],
                height: "250px",
                legend: "bottom",
                donut: true %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Active Filters Pills -->
  <%
    active_filters = []
    active_filters << { label: "Search: #{params[:search]}", param: :search } if params[:search].present?

    # Application filter pill
    if params[:application_id].present? && defined?(@applications)
      app_name = @applications.find { |name, id| id.to_s == params[:application_id].to_s }&.first
      active_filters << { label: "App: #{app_name}", param: :application_id } if app_name
    end

    active_filters << { label: "Platform: #{params[:platform]}", param: :platform } if params[:platform].present?
    active_filters << { label: "Type: #{params[:error_type]}", param: :error_type } if params[:error_type].present?
    active_filters << { label: "Severity: #{params[:severity].titleize}", param: :severity } if params[:severity].present?
    active_filters << { label: "Timeframe: #{params[:timeframe].humanize}", param: :timeframe } if params[:timeframe].present?
    active_filters << { label: "Frequency: #{params[:frequency].humanize}", param: :frequency } if params[:frequency].present?
    active_filters << { label: "Status: #{params[:status].humanize}", param: :status } if params[:status].present?
    active_filters << { label: "Priority: P#{params[:priority_level]}", param: :priority_level } if params[:priority_level].present?

    # Special handling for assigned_to
    if params[:assigned_to].present? && params[:assigned_to] != '__unassigned__' && params[:assigned_to] != '__assigned__'
      active_filters << { label: "Assigned to: #{params[:assigned_to]}", param: :assigned_to }
    elsif params[:assigned_to] == '__unassigned__'
      active_filters << { label: "Unassigned", param: :assigned_to }
    elsif params[:assigned_to] == '__assigned__'
      active_filters << { label: "Assigned", param: :assigned_to }
    end
  %>

  <% if active_filters.any? %>
    <div class="mb-3">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <small class="text-muted fw-bold">Active filters:</small>
        <% active_filters.each do |filter| %>
          <%
            # Build URL without this specific filter
            filter_params = permitted_filter_params.except(filter[:param])
          %>
          <%= link_to errors_path(filter_params), class: "badge bg-primary text-decoration-none filter-pill" do %>
            <%= filter[:label] %>
            <i class="bi bi-x ms-1"></i>
          <% end %>
        <% end %>
        <%= link_to errors_path, class: "badge bg-secondary text-decoration-none filter-pill" do %>
          <i class="bi bi-x-circle me-1"></i>
          Clear All
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Filters -->
  <div class="card mb-4" id="filters-section">
    <div class="card-header bg-white">
      <h5 class="mb-0">Filters & Search</h5>
    </div>
    <div class="card-body">
      <!-- Quick Filter Buttons -->
      <div class="d-flex gap-2 mb-3">
        <%= link_to "All Errors", errors_path,
            class: "btn btn-sm #{params[:assigned_to].blank? ? 'btn-primary' : 'btn-outline-primary'}" %>
        <%= link_to "Unassigned", errors_path(assigned_to: '__unassigned__'),
            class: "btn btn-sm #{params[:assigned_to] == '__unassigned__' ? 'btn-primary' : 'btn-outline-primary'}" %>
        <%= link_to "My Errors", errors_path(assigned_to: current_user_name),
            class: "btn btn-sm #{params[:assigned_to] == current_user_name ? 'btn-primary' : 'btn-outline-primary'}" %>
      </div>

      <%= form_with url: errors_path, method: :get, class: "row g-3", data: { turbo: false } do %>
        <div class="col-md-4">
          <%= text_field_tag :search, params[:search], placeholder: "Search errors...", class: "form-control" %>
        </div>

        <!-- Application Filter (only show if multiple apps) -->
        <% if @applications.size > 1 %>
          <div class="col-md-2">
            <%= select_tag :application_id,
                options_for_select(
                  [['All Apps', '']] + @applications,
                  params[:application_id]
                ),
                class: "form-select" %>
          </div>
        <% end %>

        <% if @platforms.size > 1 %>
          <div class="col-md-2">
            <%= select_tag :platform, options_for_select([['All Platforms', '']] + @platforms.map { |p| [p, p] }, params[:platform]), class: "form-select" %>
          </div>
        <% end %>

        <div class="col-md-2">
          <%= select_tag :error_type, options_for_select([['All Types', '']] + @error_types.map { |t| [t, t] }, params[:error_type]), class: "form-select" %>
        </div>

        <div class="col-md-2">
          <%= select_tag :severity, options_for_select([
            ['All Severities', ''],
            ['üî¥ Critical', 'critical'],
            ['üü† High', 'high'],
            ['üü° Medium', 'medium'],
            ['‚ö™ Low', 'low']
          ], params[:severity]), class: "form-select" %>
        </div>

        <!-- Time Range Filter -->
        <div class="col-md-2">
          <%= select_tag :timeframe, options_for_select([
            ['All Time', ''],
            ['Last Hour', 'last_hour'],
            ['Today', 'today'],
            ['Yesterday', 'yesterday'],
            ['Last 7 Days', 'last_7_days'],
            ['Last 30 Days', 'last_30_days'],
            ['Last 90 Days', 'last_90_days']
          ], params[:timeframe]), class: "form-select" %>
        </div>

        <!-- Frequency Filter -->
        <div class="col-md-2">
          <%= select_tag :frequency, options_for_select([
            ['All Frequencies', ''],
            ['Once', 'once'],
            ['2-9 Times', 'few'],
            ['10-99 Times', 'frequent'],
            ['100+ Times', 'very_frequent'],
            ['Recurring (Active)', 'recurring']
          ], params[:frequency]), class: "form-select" %>
        </div>

        <!-- Phase 3: Workflow Filters -->
        <div class="col-md-2">
          <%= select_tag :status, options_for_select([
            ['All Statuses', ''],
            ['üÜï New', 'new'],
            ['üîµ In Progress', 'in_progress'],
            ['üü° Investigating', 'investigating'],
            ['‚úÖ Resolved', 'resolved'],
            ['‚ö´ Won\'t Fix', 'wont_fix']
          ], params[:status]), class: "form-select" %>
        </div>

        <div class="col-md-2">
          <%= select_tag :assigned_to, options_for_select([
            ['All Assignments', ''],
            ['Unassigned', '__unassigned__'],
            ['Assigned', '__assigned__']
          ], params[:assigned_to]), class: "form-select" %>
        </div>

        <div class="col-md-2">
          <%= select_tag :priority_level, options_for_select([
            ['All Priorities', ''],
            ['üî¥ Critical (P3)', 3],
            ['üü† High (P2)', 2],
            ['üü° Medium (P1)', 1],
            ['‚ö™ Low (P0)', 0]
          ], params[:priority_level]), class: "form-select" %>
        </div>

        <div class="col-auto">
          <div class="form-check mt-2">
            <%
              # Determine checkbox state based on params
              # If unresolved param is missing or nil, default to checked (true)
              # If unresolved param is explicitly "false" or "0", uncheck it
              is_checked = if params[:unresolved].nil?
                true  # Default to checked when first loading
              else
                params[:unresolved] != "false" && params[:unresolved] != "0"
              end
            %>
            <%= check_box_tag :unresolved, "1", is_checked, class: "form-check-input", id: "unresolved_checkbox" %>
            <%= label_tag :unresolved, "Unresolved only", class: "form-check-label" %>
          </div>
        </div>

        <div class="col-auto">
          <div class="form-check mt-2">
            <%= check_box_tag :hide_snoozed, "1", params[:hide_snoozed] == "1", class: "form-check-input" %>
            <%= label_tag :hide_snoozed, "Hide snoozed", class: "form-check-label" %>
          </div>
        </div>

        <div class="col-12">
          <%= submit_tag "Apply Filters", class: "btn btn-primary" %>
          <%= link_to "Clear", errors_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Error List Table -->
  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Recent Errors</h5>
      <small class="text-muted"><%== pagy_info(@pagy) %></small>
    </div>

    <!-- Batch Actions Toolbar -->
    <div class="card-body border-bottom" id="batch-actions-toolbar" style="display: none;">
      <%= form_with url: batch_action_errors_path, method: :post, id: "batch-form" do |f| %>
        <div class="row align-items-center">
          <div class="col-auto">
            <span id="selected-count" class="fw-bold">0 selected</span>
          </div>
          <div class="col-auto">
            <%= button_tag type: "submit", name: "action_type", value: "resolve", class: "btn btn-sm btn-success" do %>
              <i class="bi bi-check-circle"></i> Resolve Selected
            <% end %>
          </div>
          <div class="col-auto">
            <%= button_tag type: "submit", name: "action_type", value: "delete", class: "btn btn-sm btn-danger", data: { confirm: "Are you sure you want to delete the selected errors?" } do %>
              <i class="bi bi-trash"></i> Delete Selected
            <% end %>
          </div>
          <div class="col-auto">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-selection">
              Clear Selection
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <div class="card-body p-0">
      <% if @errors.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="select-all" class="form-check-input">
                </th>
                <th><%= sortable_header("Severity", "severity") %></th>
                <th><%= sortable_header("Error Type", "error_type") %></th>
                <th>Message</th>
                <th><%= sortable_header("Occurrences", "occurrence_count") %></th>
                <th><%= sortable_header("First / Last Seen", "last_seen_at") %></th>

                <!-- Show App column only when viewing all apps -->
                <% if @applications.size > 1 && params[:application_id].blank? %>
                  <th><%= sortable_header("Application", "application_id") %></th>
                <% end %>

                <% if @platforms.size > 1 %>
                  <th><%= sortable_header("Platform", "platform") %></th>
                <% end %>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="error_list">
              <% @errors.each do |error| %>
                <%= render "error_row", error: error, show_platform: @platforms.size > 1, show_application: (@applications.size > 1 && params[:application_id].blank?) %>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="p-3">
          <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-check-circle display-1 text-success mb-3"></i>
          <h4 class="text-muted">All Clear!</h4>
          <p class="text-muted">
            <% if params[:search].present? || params[:error_type].present? || params[:platform].present? || params[:severity].present? %>
              No errors match your current filters. Try adjusting your search criteria.
            <% else %>
              No errors have been logged yet. Your application is running smoothly!
            <% end %>
          </p>
          <% unless params.values.compact.any? %>
            <small class="text-muted d-block mt-3">
              <i class="bi bi-lightbulb"></i> Errors will appear here automatically when they occur.
            </small>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const errorCheckboxes = document.querySelectorAll('.error-checkbox');
    const batchToolbar = document.getElementById('batch-actions-toolbar');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchForm = document.getElementById('batch-form');
    const clearSelectionBtn = document.getElementById('clear-selection');

    function updateBatchToolbar() {
      const checkedBoxes = document.querySelectorAll('.error-checkbox:checked');
      const count = checkedBoxes.length;

      if (count > 0) {
        batchToolbar.style.display = 'block';
        selectedCountSpan.textContent = `${count} selected`;
      } else {
        batchToolbar.style.display = 'none';
      }
    }

    // Select all checkbox
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        errorCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateBatchToolbar();
      });
    }

    // Individual checkboxes
    errorCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateBatchToolbar();

        // Update "select all" checkbox state
        const allChecked = Array.from(errorCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(errorCheckboxes).some(cb => cb.checked);

        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      });
    });

    // Clear selection button
    if (clearSelectionBtn) {
      clearSelectionBtn.addEventListener('click', function() {
        errorCheckboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        updateBatchToolbar();
      });
    }

    // Form submission - add selected error IDs
    if (batchForm) {
      batchForm.addEventListener('submit', function(e) {
        const checkedBoxes = document.querySelectorAll('.error-checkbox:checked');

        if (checkedBoxes.length === 0) {
          e.preventDefault();
          alert('Please select at least one error');
          return false;
        }

        // Add hidden inputs for each selected error ID
        checkedBoxes.forEach(checkbox => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'error_ids[]';
          input.value = checkbox.value;
          this.appendChild(input);
        });
      });
    }
  });

  // Turbo Stream animation for new errors
  document.addEventListener('turbo:before-stream-render', (event) => {
    const { target, action } = event.detail.newStream;

    // Highlight new errors when prepended
    if (action === 'prepend' && target === 'error_list') {
      setTimeout(() => {
        const firstRow = document.querySelector('#error_list tr:first-child');
        if (firstRow) {
          firstRow.classList.add('new-error');

          // Remove class after animation completes
          setTimeout(() => {
            firstRow.classList.remove('new-error');
          }, 3000);
        }
      }, 10);
    }

    // Pulse stats cards when updated
    if (action === 'replace' && target === 'dashboard_stats') {
      setTimeout(() => {
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
          card.classList.add('updated');
          setTimeout(() => card.classList.remove('updated'), 500);
        });
      }, 10);
    }
  });

  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ignore if typing in input/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    // 'r' - Refresh page
    if (e.key === 'r') {
      location.reload();
    }

    // '/' - Focus search
    if (e.key === '/') {
      e.preventDefault();
      const searchInput = document.querySelector('input[name="search"]');
      if (searchInput) searchInput.focus();
    }

    // 'a' - Go to analytics
    if (e.key === 'a') {
      window.location.href = '<%= analytics_errors_path %>';
    }

    // '?' - Show keyboard shortcuts help
    if (e.key === '?') {
      e.preventDefault();
      const modal = new bootstrap.Modal(document.getElementById('keyboardShortcutsModal'));
      modal.show();
    }
  });

  // Preserve scroll position on page load
  document.addEventListener('DOMContentLoaded', function() {
    const scrollPos = sessionStorage.getItem('scrollPos');
    if (scrollPos) {
      window.scrollTo(0, parseInt(scrollPos));
      sessionStorage.removeItem('scrollPos');
    }
  });

  // Handle filter form submission
  document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.querySelector('form[action="<%= errors_path %>"]');
    if (filterForm) {
      filterForm.addEventListener('submit', function(e) {
        // Save scroll position before form submission
        sessionStorage.setItem('scrollPos', window.pageYOffset);

        // Handle unchecked checkbox - when unchecked, send "0" explicitly
        const unresolvedCheckbox = document.getElementById('unresolved_checkbox');
        if (unresolvedCheckbox && !unresolvedCheckbox.checked) {
          // Create hidden input to send "0" when unchecked
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'unresolved';
          hiddenInput.value = '0';
          filterForm.appendChild(hiddenInput);
          // Remove the checkbox from form submission to avoid sending empty value
          unresolvedCheckbox.disabled = true;
        }
      });
    }
  });

  // Update browser tab title with unresolved error count
  document.addEventListener('DOMContentLoaded', function() {
    const unresolvedCount = <%= @stats[:unresolved] || 0 %>;
    if (unresolvedCount > 0) {
      document.title = `(${unresolvedCount}) ${document.title}`;
    }
  });
</script>
