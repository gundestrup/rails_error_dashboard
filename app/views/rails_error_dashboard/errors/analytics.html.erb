<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-graph-up text-primary"></i> Error Analytics</h2>
    <div>
      <%= form_with url: analytics_errors_path, method: :get, class: "d-flex gap-2" do %>
        <%= select_tag :days, options_for_select([
          ['Last 7 Days', 7],
          ['Last 14 Days', 14],
          ['Last 30 Days', 30],
          ['Last 60 Days', 60],
          ['Last 90 Days', 90]
        ], @days), class: "form-select", onchange: "this.form.submit()" %>
      <% end %>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card stat-card border-primary">
        <div class="card-body">
          <div class="stat-label mb-2 text-primary">Total Errors</div>
          <div class="stat-value text-primary"><%= @error_stats[:total] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-danger">
        <div class="card-body">
          <div class="stat-label mb-2 text-danger">Unresolved</div>
          <div class="stat-value text-danger"><%= @error_stats[:unresolved] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-success">
        <div class="card-body">
          <div class="stat-label mb-2 text-success">Resolution Rate</div>
          <div class="stat-value text-success"><%= @resolution_rate %>%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Trend Chart -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0"><i class="bi bi-graph-up"></i> Error Trend (Last <%= @days %> Days)</h5>
    </div>
    <div class="card-body">
      <%= line_chart @errors_over_time,
          color: "#8B5CF6",
          curve: false,
          points: true,
          height: "300px",
          xtitle: "Date",
          ytitle: "Number of Errors" %>
    </div>
  </div>

  <!-- Charts Row 1 -->
  <% show_platform_chart = @errors_by_platform.size > 1 %>

  <% if show_platform_chart %>
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-phone"></i> Errors by Platform</h5>
          </div>
          <div class="card-body">
            <%= pie_chart @errors_by_platform,
                colors: ["#000000", "#3DDC84", "#3B82F6"],
                height: "300px",
                legend: "bottom",
                donut: true %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Charts Row 2 -->
  <div class="row g-4 mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-bug"></i> Top 10 Error Types</h5>
        </div>
        <div class="card-body">
          <%= bar_chart @errors_by_type,
              color: "#EF4444",
              height: "400px",
              xtitle: "Error Type",
              ytitle: "Count" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 3 -->
  <div class="row g-4 mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-clock"></i> Errors by Hour of Day</h5>
        </div>
        <div class="card-body">
          <%= column_chart @errors_by_hour,
              color: "#8B5CF6",
              height: "300px",
              xtitle: "Hour",
              ytitle: "Number of Errors" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Users Table -->
  <% if @top_users.any? %>
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-people"></i> Top 10 Affected Users</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Rank</th>
                    <th>User</th>
                    <th>Error Count</th>
                    <th>Percentage</th>
                  </tr>
                </thead>
                <tbody>
                  <% @top_users.each_with_index do |(email, count), index| %>
                    <tr>
                      <td><strong>#<%= index + 1 %></strong></td>
                      <td><%= email %></td>
                      <td><span class="badge bg-danger"><%= count %></span></td>
                      <td>
                        <div class="progress" style="height: 20px;">
                          <div class="progress-bar bg-danger"
                               role="progressbar"
                               style="width: <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%"
                               aria-valuenow="<%= count %>"
                               aria-valuemin="0"
                               aria-valuemax="<%= @error_stats[:total] %>">
                            <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%
                          </div>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Error Type Breakdown Table -->
  <div class="row g-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-check"></i> Error Type Breakdown</h5>
          <small class="text-muted">Last <%= @days %> days</small>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Rank</th>
                  <th>Error Type</th>
                  <th>Count</th>
                  <th>Percentage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @error_stats[:by_type].each_with_index do |(error_type, count), index| %>
                  <tr>
                    <td><strong>#<%= index + 1 %></strong></td>
                    <td><code class="text-danger"><%= error_type %></code></td>
                    <td><span class="badge bg-secondary"><%= count %></span></td>
                    <td>
                      <div class="progress" style="height: 20px; min-width: 200px;">
                        <div class="progress-bar"
                             role="progressbar"
                             style="width: <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%"
                             aria-valuenow="<%= count %>"
                             aria-valuemin="0"
                             aria-valuemax="<%= @error_stats[:total] %>">
                          <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%
                        </div>
                      </div>
                    </td>
                    <td>
                      <%= link_to "View Errors", errors_path(error_type: error_type), class: "btn btn-sm btn-outline-primary" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
