<% content_for :page_title, "Analytics" %>

<script>
  // Dynamic chart colors based on theme
  window.getChartColors = function() {
    const isDark = document.body.classList.contains('dark-mode');
    return {
      textColor: isDark ? '#cdd6f4' : '#1f2937',
      gridColor: isDark ? 'rgba(88, 91, 112, 0.2)' : 'rgba(0, 0, 0, 0.1)'
    };
  };

  window.getChartLibraryOptions = function() {
    const colors = window.getChartColors();
    return {
      scales: {
        x: {
          ticks: { color: colors.textColor },
          title: { color: colors.textColor },
          grid: { color: colors.gridColor }
        },
        y: {
          ticks: { color: colors.textColor },
          title: { color: colors.textColor },
          grid: { color: colors.gridColor }
        }
      },
      plugins: {
        legend: { labels: { color: colors.textColor } }
      }
    };
  };
</script>

<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-graph-up text-primary"></i> Error Analytics</h2>
    <div>
      <%= form_with url: analytics_errors_path, method: :get, class: "d-flex gap-2" do %>
        <%= select_tag :days, options_for_select([
          ['Last 7 Days', 7],
          ['Last 14 Days', 14],
          ['Last 30 Days', 30],
          ['Last 60 Days', 60],
          ['Last 90 Days', 90]
        ], @days), class: "form-select", onchange: "this.form.submit()" %>
      <% end %>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card stat-card border-primary">
        <div class="card-body">
          <div class="stat-label mb-2 text-primary">Total Errors</div>
          <div class="stat-value text-primary"><%= @error_stats[:total] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-danger">
        <div class="card-body">
          <div class="stat-label mb-2 text-danger">Unresolved</div>
          <div class="stat-value text-danger"><%= @error_stats[:unresolved] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-success">
        <div class="card-body">
          <div class="stat-label mb-2 text-success">Resolution Rate</div>
          <div class="stat-value text-success"><%= @resolution_rate %>%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Trend Chart -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0"><i class="bi bi-graph-up"></i> Error Trend (Last <%= @days %> Days)</h5>
    </div>
    <div class="card-body">
      <div id="errors-over-time-chart"></div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const colors = window.getChartColors();
          new Chartkick.LineChart("errors-over-time-chart", <%= raw @errors_over_time.to_json %>, {
            color: "#8B5CF6",
            curve: false,
            points: true,
            height: "300px",
            xtitle: "Date",
            ytitle: "Number of Errors",
            library: {
              scales: {
                x: {
                  ticks: { color: colors.textColor },
                  title: { color: colors.textColor, display: true, text: 'Date' },
                  grid: { color: colors.gridColor }
                },
                y: {
                  ticks: { color: colors.textColor },
                  title: { color: colors.textColor, display: true, text: 'Number of Errors' },
                  grid: { color: colors.gridColor }
                }
              },
              plugins: {
                legend: { labels: { color: colors.textColor } }
              }
            }
          });
        });
      </script>
    </div>
  </div>

  <!-- Charts Row 1 -->
  <% show_platform_chart = @errors_by_platform.size > 1 %>

  <% if show_platform_chart %>
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-phone"></i> Errors by Platform</h5>
          </div>
          <div class="card-body">
            <div id="errors-by-platform-chart"></div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const colors = window.getChartColors();
                // Distinct, accessible colors for 5 platforms with good contrast
                const platformColors = [
                  "#2563EB", // Blue - API
                  "#10B981", // Green - Android
                  "#F59E0B", // Amber - Background Jobs
                  "#8B5CF6", // Purple - Web
                  "#EF4444"  // Red - iOS
                ];

                new Chartkick.PieChart("errors-by-platform-chart", <%= raw @errors_by_platform.to_json %>, {
                  colors: platformColors,
                  height: "300px",
                  legend: "bottom",
                  donut: true,
                  library: {
                    plugins: {
                      legend: {
                        labels: {
                          color: colors.textColor,
                          font: { size: 12, weight: 'bold' }
                        }
                      }
                      // Tooltip uses global theme-aware defaults from layout
                    }
                  }
                });
              });
            </script>
          </div>
          <div class="card-footer bg-white border-top-0">
            <div class="d-flex gap-2 flex-wrap">
              <small class="text-muted me-2">Quick Links:</small>
              <% @errors_by_platform.keys.each do |platform| %>
                <%= link_to platform, errors_path(platform: platform), class: "btn btn-sm btn-outline-secondary" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Charts Row 2 -->
  <div class="row g-4 mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-bug"></i> Top 10 Error Types</h5>
        </div>
        <div class="card-body">
          <div id="errors-by-type-chart"></div>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const colors = window.getChartColors();
              new Chartkick.BarChart("errors-by-type-chart", <%= raw @errors_by_type.to_json %>, {
                color: "#EF4444",
                height: "400px",
                xtitle: "Error Type",
                ytitle: "Count",
                library: {
                  scales: {
                    x: {
                      ticks: { color: colors.textColor },
                      title: { color: colors.textColor, display: true, text: 'Error Type' },
                      grid: { color: colors.gridColor }
                    },
                    y: {
                      ticks: { color: colors.textColor },
                      title: { color: colors.textColor, display: true, text: 'Count' },
                      grid: { color: colors.gridColor }
                    }
                  },
                  plugins: {
                    legend: { labels: { color: colors.textColor } }
                  }
                }
              });
            });
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 3 -->
  <div class="row g-4 mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-clock"></i> Errors by Hour of Day</h5>
        </div>
        <div class="card-body">
          <div id="errors-by-hour-chart"></div>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const colors = window.getChartColors();
              new Chartkick.ColumnChart("errors-by-hour-chart", <%= raw @errors_by_hour.to_json %>, {
                color: "#8B5CF6",
                height: "300px",
                xtitle: "Hour",
                ytitle: "Number of Errors",
                library: {
                  scales: {
                    x: {
                      ticks: { color: colors.textColor },
                      title: { color: colors.textColor, display: true, text: 'Hour' },
                      grid: { color: colors.gridColor }
                    },
                    y: {
                      ticks: { color: colors.textColor },
                      title: { color: colors.textColor, display: true, text: 'Number of Errors' },
                      grid: { color: colors.gridColor }
                    }
                  },
                  plugins: {
                    legend: { labels: { color: colors.textColor } }
                  }
                }
              });
            });
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Users Table -->
  <% if @top_users.any? %>
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-people"></i> Top 10 Affected Users</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Rank</th>
                    <th>User</th>
                    <th>Error Count</th>
                    <th>Percentage</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @top_users.each_with_index do |(email, count), index| %>
                    <tr>
                      <td><strong>#<%= index + 1 %></strong></td>
                      <td><%= email %></td>
                      <td><span class="badge bg-danger"><%= count %></span></td>
                      <td>
                        <div class="progress" style="height: 20px;">
                          <div class="progress-bar bg-danger"
                               role="progressbar"
                               style="width: <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%"
                               aria-valuenow="<%= count %>"
                               aria-valuemin="0"
                               aria-valuemax="<%= @error_stats[:total] %>">
                            <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%
                          </div>
                        </div>
                      </td>
                      <td>
                        <%= link_to "View Errors", errors_path(search: email), class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Error Type Breakdown Table -->
  <div class="row g-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-check"></i> Error Type Breakdown</h5>
          <small class="text-muted">Last <%= @days %> days</small>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Rank</th>
                  <th>Error Type</th>
                  <th>Count</th>
                  <th>Percentage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @error_stats[:by_type].each_with_index do |(error_type, count), index| %>
                  <tr>
                    <td><strong>#<%= index + 1 %></strong></td>
                    <td><code class="text-danger"><%= error_type %></code></td>
                    <td><span class="badge bg-secondary"><%= count %></span></td>
                    <td>
                      <div class="progress" style="height: 20px; min-width: 200px;">
                        <div class="progress-bar"
                             role="progressbar"
                             style="width: <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%"
                             aria-valuenow="<%= count %>"
                             aria-valuemin="0"
                             aria-valuemax="<%= @error_stats[:total] %>">
                          <%= (count.to_f / @error_stats[:total] * 100).round(1) %>%
                        </div>
                      </div>
                    </td>
                    <td>
                      <%= link_to "View Errors", errors_path(error_type: error_type), class: "btn btn-sm btn-outline-primary" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recurring Issues Analysis -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Recurring Issues</h5>
    </div>
    <div class="card-body">
      <% if @recurring_data[:high_frequency_errors].any? %>
        <h6 class="text-muted mb-3">High Frequency Errors</h6>
        <div class="table-responsive mb-4">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Error Type</th>
                <th>Total Occurrences</th>
                <th>Duration</th>
                <th>First Seen</th>
                <th>Last Seen</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% @recurring_data[:high_frequency_errors].first(10).each do |error| %>
                <tr>
                  <td><code class="small"><%= error[:error_type] %></code></td>
                  <td><span class="badge bg-danger"><%= error[:total_occurrences] %></span></td>
                  <td><%= error[:duration_days] %> days</td>
                  <td><small class="text-muted"><%= local_time(error[:first_seen], format: :date_only) %></small></td>
                  <td><small class="text-muted"><%= local_time(error[:last_seen], format: :datetime) %></small></td>
                  <td>
                    <% if error[:still_active] %>
                      <span class="badge bg-warning">Active</span>
                    <% else %>
                      <span class="badge bg-secondary">Inactive</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted">No high-frequency errors found in the last <%= @days %> days.</p>
      <% end %>

      <% if @recurring_data[:persistent_errors].any? %>
        <h6 class="text-muted mb-3 mt-4">Persistent Unresolved Errors</h6>
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> These errors have been unresolved for more than 7 days.
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Error Type</th>
                <th>Message</th>
                <th>Platform</th>
                <th>Count</th>
                <th>Age</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @recurring_data[:persistent_errors].first(10).each do |error| %>
                <tr>
                  <td><code class="small"><%= error[:error_type] %></code></td>
                  <td class="text-muted small"><%= error[:message] %></td>
                  <td><%= error[:platform] %></td>
                  <td><span class="badge bg-secondary"><%= error[:occurrence_count] %>x</span></td>
                  <td>
                    <span class="badge bg-warning"><%= error[:age_days] %> days</span>
                  </td>
                  <td>
                    <%= link_to "View", error_path(error[:id]), class: "btn btn-sm btn-outline-primary" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Release Comparison Charts -->
  <% if @errors_by_version.present? && @errors_by_version.count >= 2 %>
    <div class="row g-4 mb-4">
      <!-- Errors by Version Chart -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-git"></i> Errors by Release Version</h5>
          </div>
          <div class="card-body">
            <div id="errors-by-version-chart"></div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const versionData = <%= raw @errors_by_version.transform_values { |v| v[:count] }.to_json %>;
                const colors = window.getChartColors();

                new Chartkick.ColumnChart("errors-by-version-chart", versionData, {
                  colors: ["#8B5CF6", "#EF4444", "#F59E0B", "#10B981"],
                  height: "300px",
                  xtitle: "Version",
                  ytitle: "Error Count",
                  library: window.getChartLibraryOptions()
                });
              });
            </script>
          </div>
        </div>
      </div>

      <!-- Release Comparison Card -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">Latest vs Previous</h5>
          </div>
          <div class="card-body">
            <% if @release_comparison.present? %>
              <div class="mb-3">
                <small class="text-muted">Latest Version</small>
                <h4><%= @release_comparison[:latest_version] %></h4>
                <p class="mb-0">
                  <span class="badge bg-danger"><%= @release_comparison[:latest_count] %> errors</span>
                  <% if @release_comparison[:latest_critical] > 0 %>
                    <span class="badge bg-dark ms-1"><%= @release_comparison[:latest_critical] %> critical</span>
                  <% end %>
                </p>
              </div>
              <div class="mb-3">
                <small class="text-muted">Previous Version</small>
                <h4><%= @release_comparison[:previous_version] %></h4>
                <p class="mb-0">
                  <span class="badge bg-secondary"><%= @release_comparison[:previous_count] %> errors</span>
                  <% if @release_comparison[:previous_critical] > 0 %>
                    <span class="badge bg-secondary ms-1"><%= @release_comparison[:previous_critical] %> critical</span>
                  <% end %>
                </p>
              </div>
              <hr>
              <div>
                <small class="text-muted">Change</small>
                <h4 class="<%= @release_comparison[:change_percentage] > 0 ? 'text-danger' : 'text-success' %>">
                  <%= @release_comparison[:change_percentage] > 0 ? '↑' : '↓' %>
                  <%= @release_comparison[:change_percentage].abs %>%
                </h4>
              </div>
            <% else %>
              <p class="text-muted">Not enough release data for comparison.</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Problematic Releases Alert -->
    <% if @problematic_releases.any? %>
      <div class="alert alert-warning mb-4">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Problematic Releases Detected</h5>
        <p>The following releases have significantly higher error rates (&gt;2x average):</p>
        <ul class="mb-0">
          <% @problematic_releases.each do |release| %>
            <li>
              <strong><%= release[:version] %></strong>:
              <%= release[:error_count] %> errors
              (<%= release[:critical_count] %> critical,
              +<%= release[:deviation_from_avg] %>% from average)
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  <% end %>

  <!-- MTTR (Mean Time to Resolution) -->
  <% if @mttr_stats[:total_resolved] > 0 %>
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Resolution Performance (MTTR)</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-4">
          <!-- Overall MTTR -->
          <div class="col-md-3">
            <div class="card border-info">
              <div class="card-body text-center">
                <small class="text-muted d-block">Overall MTTR</small>
                <h3 class="text-info mb-0"><%= @mttr_stats[:overall_mttr] %>h</h3>
                <small class="text-muted">Average resolution time</small>
              </div>
            </div>
          </div>

          <!-- Fastest -->
          <div class="col-md-3">
            <div class="card border-success">
              <div class="card-body text-center">
                <small class="text-muted d-block">Fastest</small>
                <h3 class="text-success mb-0"><%= @mttr_stats[:fastest_resolution] || 0 %>m</h3>
                <small class="text-muted">Best resolution time</small>
              </div>
            </div>
          </div>

          <!-- Slowest -->
          <div class="col-md-3">
            <div class="card border-danger">
              <div class="card-body text-center">
                <small class="text-muted d-block">Slowest</small>
                <h3 class="text-danger mb-0"><%= @mttr_stats[:slowest_resolution] || 0 %>h</h3>
                <small class="text-muted">Longest resolution time</small>
              </div>
            </div>
          </div>

          <!-- Total Resolved -->
          <div class="col-md-3">
            <div class="card border-secondary">
              <div class="card-body text-center">
                <small class="text-muted d-block">Total Resolved</small>
                <h3 class="text-secondary mb-0"><%= @mttr_stats[:total_resolved] %></h3>
                <small class="text-muted">In last <%= @days %> days</small>
              </div>
            </div>
          </div>
        </div>

        <!-- MTTR by Platform -->
        <% if @mttr_by_platform.present? && @mttr_by_platform.any? %>
          <div class="mt-4">
            <h6 class="text-muted mb-3">MTTR by Platform</h6>
            <div id="mttr-by-platform-chart"></div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const colors = window.getChartColors();
                new Chartkick.BarChart("mttr-by-platform-chart",
                  <%= raw @mttr_by_platform.to_json %>, {
                  suffix: " hours",
                  height: "200px",
                  colors: ["#8B5CF6"],
                  library: window.getChartLibraryOptions()
                });
              });
            </script>
          </div>
        <% end %>

        <!-- MTTR by Severity -->
        <% if @mttr_stats[:mttr_by_severity].present? && @mttr_stats[:mttr_by_severity].any? %>
          <div class="mt-4">
            <h6 class="text-muted mb-3">MTTR by Severity</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Severity</th>
                    <th>Average Time to Resolution</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @mttr_stats[:mttr_by_severity].each do |severity, hours| %>
                    <tr>
                      <td>
                        <span class="badge bg-<%= severity_color(severity) %>">
                          <%= severity.to_s.capitalize %>
                        </span>
                      </td>
                      <td><strong><%= hours %> hours</strong></td>
                      <td>
                        <%= link_to "View", errors_path(severity: severity), class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% end %>

        <!-- MTTR Trend -->
        <% if @mttr_stats[:mttr_trend].present? && @mttr_stats[:mttr_trend].any? %>
          <div class="mt-4">
            <h6 class="text-muted mb-3">MTTR Trend (Weekly)</h6>
            <div id="mttr-trend-chart"></div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const colors = window.getChartColors();
                new Chartkick.LineChart("mttr-trend-chart",
                  <%= raw @mttr_stats[:mttr_trend].to_json %>, {
                  suffix: " hours",
                  height: "250px",
                  colors: ["#10B981"],
                  curve: false,
                  library: window.getChartLibraryOptions()
                });
              });
            </script>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
