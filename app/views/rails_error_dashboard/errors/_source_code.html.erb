<%# Displays source code for a backtrace frame with git blame and repository links %>
<%# Usage: render "source_code", frame: frame, error: @error, index: 0 %>

<% if RailsErrorDashboard.configuration.enable_source_code_integration %>
  <% source_data = read_source_code(frame) %>
  <% blame_data = read_git_blame(frame) if RailsErrorDashboard.configuration.enable_git_blame %>
  <% repo_link = generate_repository_link(frame, error) %>

  <% if source_data && source_data[:lines].present? %>
    <div class="source-code-viewer mt-2 mb-3 border rounded shadow-sm">
      <!-- Header with file info and actions -->
      <div class="source-code-header bg-light border-bottom">
        <!-- Top row: File path and View Source button -->
        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-file-code text-primary"></i>
            <span class="font-monospace source-file-path fw-medium" style="font-size: 0.9rem;">
              <%= frame[:short_path] %>:<%= frame[:line_number] %>
            </span>
          </div>

          <% if repo_link %>
            <%= link_to repo_link, target: "_blank", rel: "noopener",
                class: "btn btn-sm btn-primary",
                title: "View on #{repo_link.include?('github') ? 'GitHub' : repo_link.include?('gitlab') ? 'GitLab' : 'Bitbucket'}" do %>
              <i class="bi bi-box-arrow-up-right"></i> View Source
            <% end %>
          <% end %>
        </div>

        <!-- Bottom row: Git blame info (if available) -->
        <% if blame_data %>
          <div class="git-blame-info px-3 py-2 bg-white">
            <div class="d-flex align-items-center gap-3 text-muted" style="font-size: 0.85rem;">
              <div class="d-flex align-items-center gap-1">
                <i class="bi bi-person-circle"></i>
                <span><%= blame_data[:author] %></span>
              </div>
              <div class="d-flex align-items-center gap-1">
                <i class="bi bi-clock"></i>
                <span><%= time_ago_in_words(blame_data[:date]) %> ago</span>
              </div>
              <% if blame_data[:commit_message] %>
                <div class="d-flex align-items-center gap-1 flex-grow-1">
                  <i class="bi bi-chat-left-text"></i>
                  <span class="text-truncate" style="max-width: 400px;" title="<%= blame_data[:commit_message] %>">
                    <%= blame_data[:commit_message] %>
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Source code lines -->
      <div class="source-code-content bg-white">
        <div class="code-block p-0" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
          <table class="source-code-table table table-sm mb-0 font-monospace" style="font-size: 0.875rem;">
            <tbody>
              <% source_data[:lines].each do |line_data| %>
                <tr class="<%= line_data[:highlight] ? 'source-line-highlight' : 'source-line' %>">
                  <td class="source-line-number text-end pe-3 text-muted border-end" style="width: 60px; user-select: none; background-color: #f8f9fa;">
                    <%= line_data[:number] %>
                  </td>
                  <td class="source-line-content ps-3 pe-3 py-1">
                    <code class="text-dark" style="<%= line_data[:highlight] ? 'font-weight: 600;' : '' %>"><%= line_data[:content] %></code>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% elsif source_data && source_data[:error] %>
    <!-- Error message if source couldn't be read -->
    <div class="alert alert-warning mt-2 mb-2 py-2">
      <i class="bi bi-exclamation-triangle"></i>
      <small>Could not read source: <%= source_data[:error] %></small>
    </div>
  <% end %>
<% end %>
