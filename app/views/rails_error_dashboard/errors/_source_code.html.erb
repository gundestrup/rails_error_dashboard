<%# Displays source code for a backtrace frame with git blame and repository links %>
<%# Usage: render "source_code", frame: frame, error: @error, index: 0 %>

<% if RailsErrorDashboard.configuration.enable_source_code_integration %>
  <% source_data = read_source_code(frame) %>
  <% blame_data = read_git_blame(frame) if RailsErrorDashboard.configuration.enable_git_blame %>
  <% repo_link = generate_repository_link(frame, error) %>

  <% if source_data && source_data[:lines].present? %>
    <div class="source-code-viewer mt-2 mb-3 border rounded shadow-sm">
      <!-- Header with file info and actions -->
      <div class="source-code-header bg-light border-bottom">
        <!-- Top row: File path and View Source button -->
        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-file-code text-primary"></i>
            <span class="font-monospace source-file-path fw-medium" style="font-size: 0.9rem;">
              <%= frame[:short_path] %>:<%= frame[:line_number] %>
            </span>
          </div>

          <% if repo_link %>
            <%= link_to repo_link, target: "_blank", rel: "noopener",
                class: "btn btn-sm btn-primary",
                title: "View on #{repo_link.include?('github') ? 'GitHub' : repo_link.include?('gitlab') ? 'GitLab' : 'Bitbucket'}" do %>
              <i class="bi bi-box-arrow-up-right"></i> View Source
            <% end %>
          <% end %>
        </div>

        <!-- Bottom row: Git blame info (if available) -->
        <% if blame_data %>
          <div class="git-blame-info px-3 py-2 bg-white">
            <div class="d-flex align-items-center gap-3 text-muted" style="font-size: 0.85rem;">
              <div class="d-flex align-items-center gap-1">
                <i class="bi bi-person-circle"></i>
                <span><%= blame_data[:author] %></span>
              </div>
              <div class="d-flex align-items-center gap-1">
                <i class="bi bi-clock"></i>
                <span><%= time_ago_in_words(blame_data[:date]) %> ago</span>
              </div>
              <% if blame_data[:commit_message] %>
                <div class="d-flex align-items-center gap-1 flex-grow-1">
                  <i class="bi bi-chat-left-text"></i>
                  <span class="text-truncate" style="max-width: 400px;" title="<%= blame_data[:commit_message] %>">
                    <%= blame_data[:commit_message] %>
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Source code lines with syntax highlighting -->
      <div class="source-code-content bg-white">
        <div class="code-block" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
          <%
            # Find the error line number for highlighting
            error_line_number = source_data[:lines].find { |l| l[:highlight] }&.dig(:number)
            # Get start line number (first line in context)
            start_line = source_data[:lines].first[:number]
          %>
          <pre class="mb-0"><code class="language-<%= source_data[:language] || 'plaintext' %>" data-error-line="<%= error_line_number %>" data-start-line="<%= start_line %>"><%= source_data[:lines].map { |l| l[:content] }.join("\n") %></code></pre>
        </div>
      </div>
    </div>
  <% elsif source_data && source_data[:error] %>
    <!-- Error message if source couldn't be read -->
    <div class="alert alert-warning mt-2 mb-2 py-2">
      <i class="bi bi-exclamation-triangle"></i>
      <small>Could not read source: <%= source_data[:error] %></small>
    </div>
  <% end %>
<% end %>
