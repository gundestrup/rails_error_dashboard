#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'tmpdir'

# Colors for output
def green(text); "\e[32m#{text}\e[0m"; end
def red(text); "\e[31m#{text}\e[0m"; end
def yellow(text); "\e[33m#{text}\e[0m"; end
def blue(text); "\e[34m#{text}\e[0m"; end

puts blue("=" * 80)
puts blue("Rails Error Dashboard - Installation Test Suite")
puts blue("=" * 80)
puts

# Get versions
gem_root = File.expand_path('../..', __FILE__)
require "#{gem_root}/lib/rails_error_dashboard/version"

puts "Ruby Version: #{RUBY_VERSION}"
puts "Gem Version: #{RailsErrorDashboard::VERSION}"
puts "Gem Root: #{gem_root}"
puts

# Check prerequisites
unless system('which rails > /dev/null 2>&1')
  puts red("❌ Rails is not installed!")
  exit 1
end

rails_version = `rails -v`.strip
puts "Rails Version: #{rails_version}"
puts

# Test types
test_type = ARGV[0] || 'all'
valid_types = %w[all fresh upgrade quick]

unless valid_types.include?(test_type)
  puts red("Invalid test type: #{test_type}")
  puts "Valid types: #{valid_types.join(', ')}"
  exit 1
end

puts yellow("Test Type: #{test_type}")
puts

def run_test(name)
  puts blue("\n" + "=" * 80)
  puts blue("Testing: #{name}")
  puts blue("=" * 80)
  yield
  puts green("✅ #{name} - PASSED")
rescue => e
  puts red("❌ #{name} - FAILED")
  puts red("Error: #{e.message}")
  puts e.backtrace.first(5).join("\n") if ENV['VERBOSE']
  exit 1
end

def run_command(cmd, silent: false)
  puts "  $ #{cmd}" unless silent
  output = `#{cmd} 2>&1`
  success = $?.success?

  if !success && !silent
    puts red("  Command failed!")
    puts output.lines.first(10).join
  end

  { success: success, output: output }
end

# Create test directory
test_dir = Dir.mktmpdir('rails_error_dashboard_test')
gem_root = File.expand_path('../..', __FILE__)

puts "Test Directory: #{test_dir}"
puts

at_exit do
  FileUtils.rm_rf(test_dir) if File.exist?(test_dir) && !ENV['KEEP_TEST_DIR']
  puts "\nTest directory cleaned up" unless ENV['KEEP_TEST_DIR']
end

# Quick smoke test
if test_type == 'quick'
  run_test("Quick Smoke Test") do
    Dir.chdir(test_dir) do
      # Create minimal Rails app
      run_command("rails new test_app --skip-git --skip-javascript --skip-hotwire --database=sqlite3 --quiet", silent: true)

      Dir.chdir("test_app") do
        # Add gem
        File.open('Gemfile', 'a') { |f| f.puts "\ngem 'rails_error_dashboard', path: '#{gem_root}'\n" }

        # Install
        result = run_command('bundle install', silent: true)
        raise "Bundle install failed" unless result[:success]

        # Run generator
        result = run_command('rails generate rails_error_dashboard:install')
        raise "Generator failed" unless result[:success]

        # Check files exist
        raise "Initializer not created" unless File.exist?('config/initializers/rails_error_dashboard.rb')

        # Run migrations
        run_command('rails db:create', silent: true)
        result = run_command('rails db:migrate')
        raise "Migrations failed" unless result[:success]

        # Test error logging
        result = run_command('rails runner "begin; raise \'Test\'; rescue => e; RailsErrorDashboard::Commands::LogError.call(e); end"')
        raise "Error logging failed" unless result[:success]

        # Verify
        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.count"')
        raise "No errors logged" unless result[:output].strip == "1"

        puts "  ✓ All core functionality working"
      end
    end
  end

  puts
  puts green("=" * 80)
  puts green("✅ QUICK SMOKE TEST PASSED!")
  puts green("=" * 80)
  exit 0
end

# Fresh installation test
if test_type == 'all' || test_type == 'fresh'
  run_test("Fresh Installation") do
    Dir.chdir(test_dir) do
      run_command("rails new fresh_install --skip-git --skip-javascript --skip-hotwire --database=sqlite3 --quiet", silent: true)

      Dir.chdir("fresh_install") do
        puts "  Setting up Gemfile..."
        File.open('Gemfile', 'a') { |f| f.puts "\ngem 'rails_error_dashboard', path: '#{gem_root}'\n" }

        puts "  Running bundle install..."
        result = run_command('bundle install', silent: true)
        raise "Bundle install failed" unless result[:success]

        puts "  Running generator..."
        result = run_command('rails generate rails_error_dashboard:install')
        raise "Generator failed" unless result[:success]

        puts "  Verifying files..."
        raise "Initializer missing" unless File.exist?('config/initializers/rails_error_dashboard.rb')

        routes = File.read('config/routes.rb')
        raise "Routes not added" unless routes.include?('mount RailsErrorDashboard::Engine')

        puts "  Creating database..."
        run_command('rails db:create', silent: true)

        puts "  Running migrations..."
        result = run_command('rails db:migrate')
        raise "Migrations failed" unless result[:success]

        puts "  Verifying tables..."
        result = run_command('rails runner "puts ActiveRecord::Base.connection.tables.sort.join(\',\')"', silent: true)
        tables = result[:output].strip

        %w[rails_error_dashboard_error_logs rails_error_dashboard_error_baselines].each do |table|
          raise "Table #{table} not found" unless tables.include?(table)
        end

        puts "  Testing error logging..."
        run_command('rails runner "3.times { |i| begin; raise \"Test error number \#{i} at \#{Time.now.to_f}\"; rescue => e; RailsErrorDashboard::Commands::LogError.call(e, platform: \"API\"); end }"')

        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.count"')
        count = result[:output].strip.to_i
        raise "Expected at least 1 error, got #{count}" unless count >= 1

        puts "  Testing queries..."
        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.where(platform: \'API\').count"')
        api_count = result[:output].strip.to_i
        raise "Platform filter failed, expected at least 1 API error" unless api_count >= 1

        puts "  ✓ All verification steps passed"
      end
    end
  end
end

# Upgrade test
if test_type == 'all' || test_type == 'upgrade'
  run_test("Upgrade from v0.1.10") do
    Dir.chdir(test_dir) do
      run_command("rails new upgrade_test --skip-git --skip-javascript --skip-hotwire --database=sqlite3 --quiet", silent: true)

      Dir.chdir("upgrade_test") do
        puts "  Installing v0.1.10..."
        File.open('Gemfile', 'a') { |f| f.puts "\ngem 'rails_error_dashboard', '0.1.10'\n" }

        result = run_command('bundle install', silent: true)
        raise "Bundle install failed for v0.1.10" unless result[:success]

        result = run_command('rails generate rails_error_dashboard:install')
        raise "Generator failed for v0.1.10" unless result[:success]

        run_command('rails db:create', silent: true)
        result = run_command('rails db:migrate')
        raise "Migrations failed for v0.1.10" unless result[:success]

        puts "  Creating test data with v0.1.10..."
        run_command('rails runner "5.times { |i| RailsErrorDashboard::ErrorLog.create!(error_type: \'StandardError\', message: \"Old error \#{i}\", occurred_at: Time.current, platform: \'Web\') }"')

        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.count"')
        raise "Test data not created" unless result[:output].strip == "5"

        puts "  Upgrading to v#{RailsErrorDashboard::VERSION}..."
        gemfile = File.read('Gemfile')
        gemfile.gsub!(/gem 'rails_error_dashboard', '0\.1\.10'/, "gem 'rails_error_dashboard', path: '#{gem_root}'")
        File.write('Gemfile', gemfile)

        result = run_command('bundle update rails_error_dashboard', silent: true)
        raise "Bundle update failed" unless result[:success]

        puts "  Running new migrations..."
        run_command('rails rails_error_dashboard:install:migrations', silent: true)
        result = run_command('rails db:migrate')
        raise "New migrations failed" unless result[:success]

        puts "  Verifying old data preserved..."
        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.count"')
        raise "Old data lost! Expected 5, got #{result[:output].strip}" unless result[:output].strip == "5"

        puts "  Testing new error logging..."
        run_command('rails runner "begin; raise \'New error\'; rescue => e; RailsErrorDashboard::Commands::LogError.call(e); end"')

        result = run_command('rails runner "puts RailsErrorDashboard::ErrorLog.count"')
        raise "New error not logged" unless result[:output].strip == "6"

        result = run_command('rails runner "puts RailsErrorDashboard::VERSION"')
        raise "Version mismatch" unless result[:output].strip == RailsErrorDashboard::VERSION

        puts "  ✓ Upgrade successful with data preserved"
      end
    end
  end
end

puts
puts green("=" * 80)
puts green("✅ ALL TESTS PASSED!")
puts green("=" * 80)
puts
puts "Summary:"
puts "  - Fresh installation: #{test_type == 'all' || test_type == 'fresh' ? 'TESTED ✓' : 'SKIPPED'}"
puts "  - Upgrade path: #{test_type == 'all' || test_type == 'upgrade' ? 'TESTED ✓' : 'SKIPPED'}"
puts
puts "Test directory: #{test_dir}"
puts "Set KEEP_TEST_DIR=1 to preserve test directory for inspection"
